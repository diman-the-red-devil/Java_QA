Java_QA / Level 2. Medium - Продвинутые темы / Урок 04. BDD. Сucumber

[![Назад](https://img.shields.io/badge/-%D0%9D%D0%B0%D0%B7%D0%B0%D0%B4-brightgreen)](1.%20Лекция.md)
[![Содержание](https://img.shields.io/badge/-%D0%A1%D0%BE%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D0%BD%D0%B8%D0%B5-purple)](README.md)
[![Вперед](https://img.shields.io/badge/-%D0%92%D0%BF%D0%B5%D1%80%D0%B5%D0%B4-brightgreen)](3.%20Задание.md)

***

# 1. Открытие предыдущего проекта

Шаги:

1. Запустить **IntelliJ IDEA**.

2. Открыть проект прошлого урока в **IntelliJ IDEA**.

![New Maven Project - Open...](./_Files/2.%20New%20Project/01.jpg "New Maven Project - Open...")

***

# 2. Хуки

## 2.1. Настройка драйвера

Вынесем действия по настройке драйвера в хуки.

### 2.1.1. Класс DriverHooks

***DriverHooks*** - класс, который выполняет действия по настройке драйвера.

Шаги:

1. Создать файл **DriverHooks.java** в **./src/test/java/hooks**.

![New Maven Project - DriverHooks.java](./_Files/2.%20New%20Project/02.jpg "New Project - DriverHooks.java")

2. Добавить в файл **DriverHooks.java** код.

* объявление драйвера браузера

```java
// Драйвер браузера
protected static WebDriver driver;
```

* объявление логгера

```java
// Логгер
private Logger logger = LogManager.getLogger(DriverHooks.class);
```

* метод **startDriverBeforeScenario** - действия совершаемые перед каждым сценарием

```java
// Действия совершаемые перед каждым сценарием
@Before
public void startDriverBeforeScenario() {
    // Получаем параметр запуска тестов через Maven -Dbrowser
    String browser = System
        .getProperty("browser", "chrome")
        .toLowerCase();
    // Получаем экземпляр драйвера браузера
    driver = WebDriverFactory.getDriver(BrowserName.fromString(browser));
    logger.info("Драйвер стартовал!");
}
```

* метод **stopDriverAfterScenario** - действия совершаемые после каждого сценария

```java
// Действия совершаемые после каждого сценария
@After
public void stopDriverAfterScenario() {
    // Если драйвер еще существует
    if(driver != null) {
        // Закрываем его
        driver.quit();
        logger.info("Драйвер остановлен!");
    }
}
```

### 2.1.2. Полный код DriverHooks.java

[DriverHooks.java](_Sample_04/src/test/java/hooks/DriverHooks.java)

### 2.1.3. Класс SmartphoneSteps

Изменим реализацию шагов в **SmartphoneSteps.java**.

Шаги:

1. Открыть файл **SmartphoneSteps.java** в **./src/test/java/steps**.

2. Изменить в файле **SmartphoneSteps.java** код.

* объявление объектов страниц

```java
// Страницы
StartPage startPage;
```

* метод **startDriverAndOpenStartPage** - шаг **Дано** *Открыта Главная страница ДНС*

```java
@Дано("Открыта Главная страница ДНС")
public void startDriverAndOpenStartPage() {
    startPage = new StartPage(WebDriverFactory.getCurrentDriver());
    // Открыть страницу https://www.dns-shop.ru/
    WebDriverFactory.getCurrentDriver().get("https://www.dns-shop.ru/");
    logger.info("Открыта Стартовая страница сайта DNS");
}
```

* метод **openSmartphonesPage** - шаг **Когда** *Выполнен переход на страницу Смартфоны*

```java
@Когда("Выполнен переход на страницу Смартфоны")
public void openSmatphonesPage() {
    startPage.linkYes().click();
    startPage.linkSmartsAndGadget().focusOnLink();
    startPage.linkSmarts().click();
    logger.info("Выполнен переход на страницу Смартфоны");
}
```

* метод **assertTitle** - шаг **Тогда** *Проверить: В заголовке страницы отображается текст Смартфоны*

```java
@Тогда("Проверить: В заголовке страницы отображается текст Смартфоны")
public void assertTitle() {
    // Проверка заголовка страницы
    logger.info("Проверка заголовка страницы");
    Assertions.assertTrue(smartphonesPage.getPageTitle().contains("Смартфоны"),
        "В заголовке страницы не отображается текст Смартфоны");
}
```

### 2.1.4. Полный код SmartphoneSteps.java

[SmartphoneSteps.java](_Sample_04/src/test/java/steps/SmartphoneSteps.java)

### 2.1.5. Фича Smartphone

Шаги:

1. Открыть файл **Smartphone.feature** в **./src/test/resources/features**.

2. Изменить сценарий:

* шаг **Дано** *Открыта Главная страница ДНС*

```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны

  Я как посетитель сайта ДНС хочу просматривать раздел со смартфонами.
  Это позволит мне выбрать понравившийся смартфон и просмотреть его характеристики.

  Сценарий: Просмотр страницы Смартфоны
    Дано Открыта Главная страница ДНС
    Когда Выполнен переход на страницу Смартфоны
    Тогда Проверить: В заголовке страницы отображается текст Смартфоны
```

## 2.2. Снятие скриншотов

Добавим снятие скриншотов до и после каждого шага в хуки.

### 2.2.1. Класс ScreenShotHooks

***ScreenShotHooks*** - класс, который выполняет действия по снятию скриншотов.

Шаги:

1. Создать файл **ScreenShotHooks.java** в **./src/test/java/hooks**.

![New Maven Project - ScreenShotHooks.java](./_Files/2.%20New%20Project/03.jpg "New Project - ScreenShotHooks.java")

2. Добавить в файл **ScreenShotHooks.java** код.

* объявление логгера

```java
// Логгер
private Logger logger = LogManager.getLogger(ScreenShotHooks.class);
```

* метод **takeScreenShotBeforeStep** - действия совершаемые перед каждым шагом

```java

// Действия совершаемые перед каждым шагом
@BeforeStep
public void takeScreenShotBeforeStep(Scenario scenario) {
    // Сделать скриншот видимой области веб страницы
    try {
        Screenshot screenshot = new AShot().takeScreenshot(
            WebDriverFactory.getCurrentDriver());
        String name = scenario.getName() + "-" + Timestamp.from(Instant.now()).getTime() + ".png";
        ImageIO.write(screenshot.getImage(), "png",
            new File("temp\\" + name));
        logger.info("Скриншот сохранен в файле [temp\\" + name + "]");
    } catch (IOException e) {
        e.printStackTrace();
    }
}
```

* метод **takeScreenShotAfterStep** - действия совершаемые после каждого шага

```java
// Действия совершаемые после каждого шага
@AfterStep
public void takeScreenShotAfterStep(Scenario scenario) {
    // Сделать скриншот видимой области веб страницы
    try {
        Screenshot screenshot = new AShot().takeScreenshot(
            WebDriverFactory.getCurrentDriver());
        String name = scenario.getName() + "-" + Timestamp.from(Instant.now()).getTime() + ".png";
        ImageIO.write(screenshot.getImage(), "png",
            new File("temp\\" + name));
        logger.info("Скриншот сохранен в файле [temp\\" + name + "]");
    } catch (IOException e) {
        e.printStackTrace();
    }
}
```

### 2.2.2. Полный код ScreenShotHooks.java

[ScreenShotHooks.java](_Sample_04/src/test/java/hooks/ScreenShotHooks.java)

## 2.3. Запуск тестовых сценариев

Шаги:

1. Открыть **.feature** файл **Smartphone.feature**

2. Запустить сценарий **Просмотр страницы Смартфоны**

3. Получить результаты запуска в консоли

![New Maven Project - Результаты запуска сценария](./_Files/2.%20New%20Project/04.jpg "New Project - Результаты запуска сценария")

4. Проверить сохранение скриншотов в папке **temp**

![New Maven Project - Результаты запуска сценария](./_Files/2.%20New%20Project/05.jpg "New Project - Результаты запуска сценария")

***

# 3. Предыстория

## 3.1. Фича Smartphone

Добавим новый сценарий

Шаги:

1. Открыть файл **Smartphone.feature** в **./src/test/resources/features**.

2. Добавить сценарий **Фильтрация и сортировка смартфонов на странице Смартфоны**:

* заголовок сценария - **Фильтрация и сортировка смартфонов на странице Смартфоны**

```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны
  ...
  Сценарий: Фильтрация и сортировка смартфонов на странице Смартфоны
```

* шаги сценария

```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны
  ...
  Сценарий: Фильтрация и сортировка смартфонов на странице Смартфоны
    Дано Открыта Главная страница ДНС
    Когда Выполнен переход на страницу Смартфоны
    И Установлена сортировка "Сначала дорогие"
    И В фильтре "Производитель" выбрано значение "Samsung"
    И В фильтре "Объем оперативной памяти" выбрано значение "10 Гб"
    И Применены выбранные фильтры
    И Выполнен переход на страницу первого товара из списка
    Тогда Проверить: В заголовке страницы отображается текст "Samsung"
```

## 3.2. Класс SmartphoneSteps

Шаги:

1. Открыть файл **SmartphoneSteps.java** в **./src/test/java/steps**.

2. Добавить в файл **SmartphoneSteps.java** код.

* метод **setSortBy** - шаг **И** *Установлена сортировка {string}*

```java
@И("Установлена сортировка {string}")
public void setSortBy(String sortBy) {
    smartphonesPage.accordeonSort().show();
    smartphonesPage.radioButtonSort(sortBy).setSelected(true);
    logger.info("Установлена сортировка" + sortBy);
}
```

* метод **setFilterBy** - шаг **И** *В фильтре {string} выбрано значение {string}*

```java
@И("В фильтре {string} выбрано значение {string}")
public void setFilterBy(String filterBy, String value) {
    JavaScriptHelper.scrollBy(0,400);
    switch (filterBy) {
        case "Производитель":
            smartphonesPage.checkBoxCompany(value).setChecked(true);
            break;
        case "Объем оперативной памяти":
            smartphonesPage.accordeonRAM().show();
            smartphonesPage.checkBoxRAM(value).setChecked(true);
            break;
    }
    logger.info("В фильтре " + filterBy + " выбрано значение " + value);
}
```

* метод **applyFilters** - шаг **И** *Применены выбранные фильтры*

```java
@И("Применены выбранные фильтры")
public void applyFilters() {
    JavaScriptHelper.scrollBy(0,400);
    smartphonesPage.buttonApply().click();
    logger.info("Применены выбранные фильтры");
}
```

* метод **selectFirstSmartphone** - шаг **И** *Выполнен переход на страницу первого товара из списка*

```java
@И("Выполнен переход на страницу первого товара из списка")
public void selectFirstSmartphone() {
    JavaScriptHelper.scrollBy(0, -600);
    smartphonesPage.linkFirstProduct().click();
    logger.info("Выполнен переход на страницу первого товара из списка");
}
```

* метод **assertTitleSmartphoneProduct** - шаг **Тогда** *Проверить: В заголовке страницы отображается текст {string}*

```java
@Тогда("Проверить: В заголовке страницы отображается текст {string}")
public void assertTitleSmartphoneProduct(String company) {
    // Проверка заголовка страницы
    logger.info("Проверка заголовка страницы");
    Assertions.assertTrue(smartphoneProductPage.getPageTitle().contains(company), "В заголовке страницы не отображается текст " + company);
}
```

## 3.3. Запуск всех тестовых сценариев

Шаги:

1. Открыть **.feature** файл **Smartphone.feature**

2. Запустить все сценарии

3. Получить результаты запуска в консоли

## 3.4. Фича Smartphone. Добавление Предыстории

Как видим у двух сценариев есть общие шаги - это контекст, который можно вынести за сценарии.

Шаги:

1. Открыть файл **Smartphone.feature** в **./src/test/resources/features**.

2. Изменить сценарий:

* предыстория

```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны

  Я как посетитель сайта ДНС хочу просматривать раздел со смартфонами.
  Это позволит мне выбрать понравившийся смартфон и просмотреть его характеристики.

  Предыстория:
    Дано Открыта Главная страница ДНС
    И Выполнен переход на страницу Смартфоны
```

* сценарии


```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны

  Я как посетитель сайта ДНС хочу просматривать раздел со смартфонами.
  Это позволит мне выбрать понравившийся смартфон и просмотреть его характеристики.

  Предыстория:
    Дано Открыта Главная страница ДНС
    И Выполнен переход на страницу Смартфоны

  Сценарий: Просмотр страницы Смартфоны
    Тогда Проверить: В заголовке страницы отображается текст Смартфоны

  Сценарий: Фильтрация и сортировка смартфонов на странице Смартфоны
    Дано Установлена сортировка "Сначала дорогие"
    И В фильтре "Производитель" выбрано значение "Samsung"
    И В фильтре "Объем оперативной памяти" выбрано значение "8 Гб"
    Когда Применены выбранные фильтры
    И Выполнен переход на страницу первого товара из списка
    Тогда Проверить: В заголовке страницы отображается текст "Samsung"
```

## 3.5. Запуск всех тестовых сценариев

Шаги:

1. Открыть **.feature** файл **Smartphone.feature**

2. Запустить все сценарии

3. Получить результаты запуска в консоли (результаты такие же как и в п 3.3.)

***

# 4. Структура сценария

## 4.1. Фича Smartphone. Добавление Структуры сценария

А что если мы захотим для второго сценария прогнать кейсы с другими параметрами фильтрации.
Для этого есть Структура сценария, которая позволяет запускать параметризованные тесты (Data Driven Testing)

Шаги:

1. Открыть файл **Smartphone.feature** в **./src/test/resources/features**.

2. Изменить сценарий:

* структуры сценария

```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны
  ...
  Структура сценария: Фильтрация и сортировка смартфонов на странице Смартфоны
```

* заменить значения параметрами

```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны
  ...
  Структура сценария: Фильтрация и сортировка смартфонов на странице Смартфоны
    Дано Установлена сортировка <sortBy>
    И В фильтре <filterBy1> выбрано значение <value1>
    И В фильтре <filterBy2> выбрано значение <value2>
    Когда Применены выбранные фильтры
    И Выполнен переход на страницу первого товара из списка
    Тогда Проверить: В заголовке страницы отображается текст <value1>
```

* добавить таблицу с примерами

```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны

  Я как посетитель сайта ДНС хочу просматривать раздел со смартфонами.
  Это позволит мне выбрать понравившийся смартфон и просмотреть его характеристики.

  Предыстория:
    Дано Открыта Главная страница ДНС
    И Выполнен переход на страницу Смартфоны

  Сценарий: Просмотр страницы Смартфоны
    Тогда Проверить: В заголовке страницы отображается текст Смартфоны

  Структура сценария: Фильтрация и сортировка смартфонов на странице Смартфоны
    Дано Установлена сортировка <sortBy>
    И В фильтре <filterBy1> выбрано значение <value1>
    И В фильтре <filterBy2> выбрано значение <value2>
    Когда Применены выбранные фильтры
    И Выполнен переход на страницу первого товара из списка
    Тогда Проверить: В заголовке страницы отображается текст <value1>
    Примеры:
      | sortBy               | filterBy1       | value1    | filterBy2                  | value2 |
      | "Сначала дорогие"    | "Производитель" | "Samsung" | "Объем оперативной памяти" | "8 Гб" |
      | "Сначала популярные" | "Производитель" | "Samsung" | "Объем оперативной памяти" | "8 Гб" |
      | "Сначала популярные" | "Производитель" | "Apple"   | "Объем оперативной памяти" | "6 Гб" |
      | "По наименованию"    | "Производитель" | "Xiaomi"  | "Объем оперативной памяти" | "4 Гб" |
```

## 4.2. Запуск тестовых сценариев

Шаги:

1. Открыть **.feature** файл **Smartphone.feature**

2. Запустить сценарии **Фильтрация и сортировка смартфонов на странице Смартфоны**

3. Получить результаты запуска в консоли (результаты такие же как и в п 3.3.)

***

# 1. Проперти файл






# 5. Таблицы




***

Задание [![Перейти](https://img.shields.io/badge/-%D0%9F%D0%B5%D1%80%D0%B5%D0%B9%D1%82%D0%B8-blue)](3.%20Задание.md)