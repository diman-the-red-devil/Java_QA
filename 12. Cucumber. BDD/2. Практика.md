Java_QA / 12. Cucumber. BDD

[![Лекция](https://img.shields.io/badge/-Лекция-ee99ff)](1.%20Лекция.md)
[![Главная](https://img.shields.io/badge/-Главная-aaccee)](README.md)
[![Задание](https://img.shields.io/badge/-Задание-99ffee)](3.%20Задание.md)

***

# Содержание

* []()
* []()
* []()
* []()

***

# 1. Открытие предыдущего проекта

[![Содержание](https://img.shields.io/badge/-Содержание-66eeff)](#содержание)

Шаги:

1. Запустить **IntelliJ IDEA**.

2. Открыть проект прошлого урока в **IntelliJ IDEA**.

![New Maven Project - Open...](./_Files/2.%20New%20Project/1.%20Open%20Project/01.jpg "New Maven Project - Open...")

***

# 2. Файл POM

Для начала нужно прописать необходимые зависимости.

![New Maven Project - POM.xml](./_Files/2.%20New%20Project/2.%20POM/01.png "New Project - POM.xml")

## 2.1. Раздел \<properties\>

Раздел **<properties>**

```xml
<!-- Параметры -->
<properties>
    Добавлять вот сюда
</properties>
```

Шаги:

1. Открыть файл **POM.xml**.

2. Добавить в раздел **\<properties\>** версии библиотек / зависимостей (**dependencies**):

* фреймворк **BDD** **Cucumber**

```xml
...
<!-- Версии зависимостей: -->
<!-- Cucumber -->
<cucumber>7.8.1</cucumber>
```

* фреймворк тестирования **JUnit**

```xml
...
<!-- JUnit -->
<junit-jupiter-engine>5.9.0</junit-jupiter-engine>
<junit-vintage-engine>5.9.0</junit-vintage-engine>
<!--junit-jupiter-api>5.9.0</junit-jupiter-api>
<junit-platform-commons>1.9.0</junit-platform-commons>
<junit-platform-launcher>1.9.0</junit-platform-launcher-->
```

* драйвер браузера **Selenium WebDriver**

```xml
...
<!-- Selenium WebDriver -->
<selenium-java>4.5.3</selenium-java>
```

* менеджер драйверов **WebDriver Manager**

```xml
...
<!-- WebDriver Manager -->
<webdrivermanager>5.3.0</webdrivermanager>
```

* логгер **Log4J**

```xml
...
<!-- Log4J -->
<log4j-api>2.19.0</log4j-api>
<log4j-core>2.19.0</log4j-core>
```

* скриншотер **aShot**

```xml
...
<!-- aShot -->
<ashot>1.5.4</ashot>
```

## 2.2. Раздел \<dependencies\>

Раздел **<dependencies>**

```xml
<!-- Зависимости -->
<dependencies>
    Добавлять вот сюда
</dependencies>
```  

Шаги:

1. Открыть файл **POM.xml**.

2. Добавить в раздел **\<dependencies\>** зависимости / библиотеки:

* фреймворк **BDD** **Cucumber**

```xml
<!-- Cucumber -->
<dependency>
    <groupId>io.cucumber</groupId>
    <artifactId>cucumber-java</artifactId>
    <version>${cucumber}</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>io.cucumber</groupId>
    <artifactId>cucumber-junit</artifactId>
    <version>${cucumber}</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>io.cucumber</groupId>
    <artifactId>cucumber-junit-platform-engine</artifactId>
    <version>${cucumber}</version>
    <scope>test</scope>
</dependency>
```

* фреймворк тестирования **JUnit**

**junit-jupiter-engine** -

**junit-vintage-engine** -

**junit-jupiter-api** -

**junit-platform-commons** -

**junit-platform-launcher** -

```xml
<!-- JUnit -->
<dependency>
    <groupId>org.junit.jupiter</groupId>
    <artifactId>junit-jupiter-engine</artifactId>
    <version>${junit-jupiter-engine}</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.junit.vintage</groupId>
    <artifactId>junit-vintage-engine</artifactId>
    <version>${junit-vintage-engine}</version>
    <scope>test</scope>
</dependency>
<!--dependency>
    <groupId>org.junit.jupiter</groupId>
    <artifactId>junit-jupiter-api</artifactId>
    <version>${junit-jupiter-api}</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.junit.platform</groupId>
    <artifactId>junit-platform-commons</artifactId>
    <version>${junit-platform-commons}</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.junit.platform</groupId>
    <artifactId>junit-platform-launcher</artifactId>
    <version>${junit-platform-launcher}</version>
    <scope>test</scope>
</dependency-->
```    

* драйвер браузера **Selenium WebDriver**

```xml
<!-- Selenium WebDriver -->
<dependency>
    <groupId>org.seleniumhq.selenium</groupId>
    <artifactId>selenium-java</artifactId>
    <version>${selenium-java}</version>
    <scope>test</scope>
</dependency>
```

* менеджер драйверов **WebDriver Manager**

```xml
<!-- WebDriver Manager -->
<dependency>
    <groupId>io.github.bonigarcia</groupId>
    <artifactId>webdrivermanager</artifactId>
    <version>${webdrivermanager}</version>
    <scope>test</scope>
</dependency>
```

* логгер **Log4J**

```xml
<!-- Log4J -->
<dependency>
    <groupId>org.apache.logging.log4j</groupId>
    <artifactId>log4j-api</artifactId>
    <version>${log4j-api}</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.apache.logging.log4j</groupId>
    <artifactId>log4j-core</artifactId>
    <version>${log4j-core}</version>
    <scope>test</scope>
</dependency>
```

* скриншотер **aShot**

```xml
<!-- aShot -->
<dependency>
    <groupId>ru.yandex.qatools.ashot</groupId>
    <artifactId>ashot</artifactId>
    <version>${ashot}</version>
    <scope>test</scope>
</dependency>
```

## 2.3. Полный код POM.xml

[POM.xml](_Sample/pom.xml)

***

# 3. Структура папок и файлов проекта

Для дальнейшей работы с фреймворком **Cucumber** необходимо настроить структуру папок проекта.

В общем случае может быть любая конфигурация пакетов и папок с файлами.

## 3.1. Структура папок ДО

Изначально все выглядит так:

![New Maven Project - ./src/test](./_Files/2.%20New%20Project/3.%20Project%20Structure/01.png "New Project - ./src/test")

## 3.2. Папки и пакеты

### 3.2.1. Пакеты с .java файлами

Шаги:

1. Создать пакет Java **web** в папке **./src/test/java**.

В данном пакете будут находиться пакеты с **.java** файлами, в которых описаны классы и
методы для взаимодействия с тестируемой системой - сайтом **DNS** в веб браузере.

![New Maven Project - ./src/test/java/web](./_Files/2.%20New%20Project/3.%20Project%20Structure/02.png "New Project - ./src/test/java/web")

2. Перенести в **./src/test/java/web** следующие пакеты:

* **drivers**
* **helpers**
* **elements**
* **pages**

![New Maven Project - ./src/test/java/web](./_Files/2.%20New%20Project/3.%20Project%20Structure/03.png "New Project - ./src/test/java/web")

3. Создать пакет Java **hooks** в папке **./src/test/java**.

В данном пакете будут находиться **.java** файлы c действиями,
выполняемыми до и после исполнения сценариев / шагов описанных в **.feature** файлах.

![New Maven Project - ./src/test/java/hooks](./_Files/2.%20New%20Project/3.%20Project%20Structure/04.png "New Project - ./src/test/java/hooks")

4. Остальные пакеты Java оставить в папке **./src/text/java**

* **models** 
* **steps**

5. В итоге должна получиться такая структура пакетов Java

![New Maven Project - ./src/test/java/steps](./_Files/2.%20New%20Project/3.%20Project%20Structure/05.png "New Project - ./src/test/java/steps")

### 3.2.2. Папка с .feature файлами

Шаги:

1. Создать папку **resources** в папке **./src/test**.

![New Maven Project - ./src/test/resources](./_Files/2.%20New%20Project/3.%20Project%20Structure/06.png "New Project - ./src/test/resources")

2. Создать папку **features** в папке **./src/test/resources**.

В данной папке будут находиться **.feature** файлы.
Вообще можно разместить папку с данными файлами в любом другом месте, 
но в Java принято размещать любые файлы не содержащие исходный код в папку **resources**.

![New Maven Project - ./src/test/resources/features](./_Files/2.%20New%20Project/3.%20Project%20Structure/07.png "New Project - ./src/test/resources/features")

## 3.3. Файлы

### 3.3.1. Удаление и переименование файлов пакета models

Шаги:

1. Перейти в пакет **./src/test/java/models**

2. Удалить следующие файлы:

* **SmartphonePOJO.java**
* **SmartphoneJB.java**
* **SmartphoneVO.java**

3. Переименовать следующие файлы:

* **SmartphoneBL.java** -> **Smartphone.java**
* **SmartphoneBLBuilder.java** -> **SmartphoneBuilder.java**

4. В итоге должно получиться вот так 

![New Maven Project - ./src/test/java/models](./_Files/2.%20New%20Project/3.%20Project%20Structure/08.png "New Project - ./src/test/java/models")

### 3.3.2. Удаление и переименование файлов пакета pages

Шаги:

1. Перейти в пакет **./src/test/java/web/pages**

2. Удалить следующие файлы:

* **StartPage.java**
* **StartPagePF.java**
* **SmartphonesPage.java**
* **SmartphonesPagePF.java**
* **SmartphoneProductPage.java**
* **SmartphoneProductPagePF.java**

3. Переименовать следующие файлы:

* **StartPagePFPE.java** -> **StartPage.java**
* **SmartphonesPagePFPE.java** -> **SmartphonesPage.java**
* **SmartphoneProductPagePFPE.java** -> **SmartphoneProductPage.java**

4. В итоге должно получиться вот так

![New Maven Project - ./src/test/java/web/pages](./_Files/2.%20New%20Project/3.%20Project%20Structure/09.png "New Project - ./src/test/java/web/pages")

### 3.3.3. Удаление пакета tests

Шаги:

1. Удалить пакет **./src/test/java/tests**

## 3.4. Структура папок ДО

В результате все выглядит так:

![New Maven Project - ./src/test](./_Files/2.%20New%20Project/3.%20Project%20Structure/10.png "New Project - ./src/test")

***

# 4. Хуки

## 4.1. Класс DriverHooks

***DriverHooks*** - класс, который выполняет действия по настройке драйвера.

Шаги:

1. Создать файл **DriverHooks.java** в **./src/test/java/models**.

![New Maven Project - DriverHooks.java](./_Files/2.%20New%20Project/3.%20Plain%20Old%20Java%20Object/01.jpg "New Project - DriverHooks.java")

2. Добавить в файл **DriverHooks.java** код.

* объявление драйвера браузера

```java
// Драйвер браузера
protected static WebDriver driver;
```

* объявление логгера

```java
// Логгер
private Logger logger = LogManager.getLogger(DriverHooks.class);
```

* метод **startDriverBeforeScenario** - действия совершаемые перед каждым сценарием

```java
// Действия совершаемые перед каждым сценарием
@Before
public void startDriverBeforeScenario() {
    // Получаем параметр запуска тестов через Maven -Dbrowser
    String browser = System
        .getProperty("browser", "chrome")
        .toLowerCase();
    // Получаем экземпляр драйвера браузера
    driver = WebDriverFactory.getDriver(BrowserName.fromString(browser));
    logger.info("Драйвер стартовал!");
}
```

* метод **stopDriverAfterScenario** - действия совершаемые после каждого сценария

```java
// Действия совершаемые после каждого сценария
@After
public void stopDriverAfterScenario() {
    // Если драйвер еще существует
    if(driver != null) {
        // Закрываем его
        driver.quit();
        logger.info("Драйвер остановлен!");
    }
}
```
## 4.2. Полный код DriverHooks.java

[DriverHooks.java](_Sample/src/test/java/hooks/DriverHooks.java)

## 4.3. Класс ScreenShotHooks

***ScreenShotHooks*** - класс, .

Шаги:

1. Создать файл **ScreenShotHooks.java** в **./src/test/java/models**.

![New Maven Project - ScreenShotHooks.java](./_Files/2.%20New%20Project/3.%20Plain%20Old%20Java%20Object/01.jpg "New Project - ScreenShotHooks.java")

2. Добавить в файл **ScreenShotHooks.java** код.

* объявление логгера

```java
// Логгер
private Logger logger = LogManager.getLogger(ScreenShotHooks.class);
```

* метод **takeScreenShotBeforeStep** - действия совершаемые перед каждым шагом

```java

// Действия совершаемые перед каждым шагом
@BeforeStep
public void takeScreenShotBeforeStep(Scenario scenario) {
    // Сделать скриншот видимой области веб страницы
    try {
        Screenshot screenshot = new AShot().takeScreenshot(
            WebDriverFactory.getCurrentDriver());
        String name = scenario.getName() + "-" + Timestamp.from(Instant.now()).getTime() + ".png";
        ImageIO.write(screenshot.getImage(), "png",
            new File("temp\\" + name));
        logger.info("Скриншот сохранен в файле [temp\\" + name + "]");
    } catch (IOException e) {
        e.printStackTrace();
    }
}
```

* метод **takeScreenShotAfterStep** - действия совершаемые после каждого шага

```java
// Действия совершаемые после каждого шага
@AfterStep
public void takeScreenShotAfterStep(Scenario scenario) {
    // Сделать скриншот видимой области веб страницы
    try {
        Screenshot screenshot = new AShot().takeScreenshot(
            WebDriverFactory.getCurrentDriver());
        String name = scenario.getName() + "-" + Timestamp.from(Instant.now()).getTime() + ".png";
        ImageIO.write(screenshot.getImage(), "png",
            new File("temp\\" + name));
        logger.info("Скриншот сохранен в файле [temp\\" + name + "]");
    } catch (IOException e) {
        e.printStackTrace();
    }
}
```

## 4.4. Полный код ScreenShotHooks.java

[DriverHooks.java](_Sample/src/test/java/hooks/ScreenShotHooks.java)

***

# 6. Фичи и сценарии

## 6.1. Фича Smartphone

***Smartphone*** - **.feature** файл, содержащий сценарии.

Шаги:

1. Создать файл **Smartphone.feature** в **./src/test/resources/features**.

![New Maven Project - Smartphone.feature](./_Files/2.%20New%20Project/38.jpg "New Project - Smartphone.feature")

2. Добавить в файл **Smartphone.feature**:

* язык сценариев - **русский**

```gherkin
# language: ru
```

* кодировка - **utf-8**

```gherkin
# encoding: utf-8
```

* заголовок фичи - **Смартфоны**

```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны
```

* описание (пользовательская история)

```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны

  Я как посетитель сайта ДНС хочу просматривать раздел со смартфонами.
  Это позволит мне выбрать понравившийся смартфон и просмотреть его характеристики.

```

### 6.1.1. Сценарий Просмотр страницы Смартфоны

***Просмотр страницы Смартфоны*** - сценарий просмотра страницы "Смартфоны".

Шаги:

1. Открыть файл **Smartphone.feature** в **./src/test/resources/features**.

2. Добавить сценарий:

* заголовок сценария - **Просмотр страницы Смартфоны**

```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны

  Я как посетитель сайта ДНС хочу просматривать раздел со смартфонами.
  Это позволит мне выбрать понравившийся смартфон и просмотреть его характеристики.

  Сценарий: Просмотр страницы Смартфоны
```

* шаг **Дано** *Запущен браузер и открыта Главная страница ДНС*

```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны

  Я как посетитель сайта ДНС хочу просматривать раздел со смартфонами.
  Это позволит мне выбрать понравившийся смартфон и просмотреть его характеристики.

  Сценарий: Просмотр страницы Смартфоны
    Дано Запущен браузер и открыта Главная страница ДНС
```

* шаг **Когда** *Выполнен переход на страницу Смартфоны*

```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны

  Я как посетитель сайта ДНС хочу просматривать раздел со смартфонами.
  Это позволит мне выбрать понравившийся смартфон и просмотреть его характеристики.

  Сценарий: Просмотр страницы Смартфоны
    Дано Запущен браузер и открыта Главная страница ДНС
    Когда Выполнен переход на страницу Смартфоны
```

* шаг **Тогда** *Проверить: В заголовке страницы отображется текст Смартфоны*

```gherkin
# language: ru
# encoding: utf-8
Функция: Смартфоны

  Я как посетитель сайта ДНС хочу просматривать раздел со смартфонами.
  Это позволит мне выбрать понравившийся смартфон и просмотреть его характеристики.

  Сценарий: Просмотр страницы Смартфоны
    Дано Запущен браузер и открыта Главная страница ДНС
    Когда Выполнен переход на страницу Смартфоны
    Тогда Проверить: В заголовке страницы отображется текст Смартфоны
```

## 6.2. Полный код Smartphone.feature

[Smartphone.feature](_Sample_03/src/test/resources/features/Smartphone.feature)

***

# 7. Шаги

## 7.1. Класс SmartphoneSteps 

***SmartphoneSteps*** - класс с реализацией шагов сценариев.

Шаги:

1. Создать файл **SmartphoneSteps.java** в **./src/test/java/steps**.

![New Maven Project - SmartphoneSteps.java](./_Files/2.%20New%20Project/39.jpg "New Project - SmartphoneSteps.java")

2. Добавить в файл **SmartphoneSteps.java** код.

* объявление драйвера браузера

```java
// Драйвер браузера
protected static WebDriver driver;
```
* объявление логгера

```java
// Логгер
private Logger logger = LogManager.getLogger(SmartphoneSteps.class);
```

* метод **startDriverAndOpenStartPage** - шаг **Дано** *Запущен браузер и открыта Главная страница ДНС*

```java
@Дано("Запущен браузер и открыта Главная страница ДНС")
public void startDriverAndOpenStartPage() {
    // Запустить драйвер
    driver = WebDriverFactory.getDriver(BrowserName.fromString("Chrome"));
    logger.info("Драйвер стартовал!");
    // Открыть страницу https://www.dns-shop.ru/
    driver.get("https://www.dns-shop.ru/");
    logger.info("Открыта Стартовая страница сайта DNS");
}
```

* метод **openSmartphonesPage** - шаг **Когда** *Выполнен переход на страницу Смартфоны*

```java
@Когда("Выполнен переход на страницу Смартфоны")
public void openSmatphonesPage() {
    StartPage startPage = new StartPage(driver);
    startPage.linkYes().click();
    startPage.linkSmartsAndGadget().focusOnLink();
    startPage.linkSmarts().click();
    logger.info("Выполнен переход на страницу Смартфоны");
}
```

* метод **assertTitle** - шаг **Тогда** *Проверить: В заголовке страницы отображается текст Смартфоны*


```java
@Тогда("Проверить: В заголовке страницы отображается текст Смартфоны")
public void assertTitle() {
    SmartphonesPage smartphonesPage = new SmartphonesPage(driver);
    // Проверка заголовка страницы
    Assertions.assertTrue(smartphonesPage.getPageTitle().contains("Смартфоны"));
    // Если драйвер еще существует
    if(driver != null) {
        // Закрываем его
        driver.quit();
        logger.info("Драйвер остановлен!");
    }
}
```

## 7.2. Полный код SmartphoneSteps.java

[SmartphoneSteps.java](_Sample_03/src/test/java/steps/SmartphoneSteps.java)

***

# 8. Раннер

***RunCucumberTest*** - класс для запуска сценариев.

Шаги:

1. Создать файл **RunCucumberTest.java** в **./src/test/java**.

![New Maven Project - RunCucumberTest.java](./_Files/2.%20New%20Project/40.jpg "New Project - RunCucumberTest.java")

2. Добавить в файл **RunCucumberTest.java** код.

* указание класса для запуска тестов

```java
// @RunWith
// Указание класса для запуска тестов
@RunWith(Cucumber.class)
```

* указание опций для запуска сценариев

```java
// @CucumberOptions
// Указание опции для запуска сценариев
@CucumberOptions(
    // Список папок с feature файлами - фичи/сценарии
    features = {"src/test/resources/features"},
    // Спиcок пакетов с steps файлами - шаги
    glue = {"steps"}
)
```

***

# 9. Запуск тестовых сценариев

## 9.1. С помощью IntelliJ IDEA

Шаги:

1. Открыть **.feature** файл **Smartphone.feature**

2. Запустить только один сценария

![New Maven Project - Запуск 1 сценария](./_Files/2.%20New%20Project/41.jpg "New Project - Запуск 1 сценария")

![New Maven Project - Запуск 1 сценария](./_Files/2.%20New%20Project/42.jpg "New Project - Запуск 1 сценария")

3. Запустить все сценарии функции

![New Maven Project - Запуск всех сценариев](./_Files/2.%20New%20Project/43.jpg "New Project - Запуск всех сценариев")

![New Maven Project - Запуск всех сценариев](./_Files/2.%20New%20Project/44.jpg "New Project - Запуск всех сценариев")

4. Получить результаты запуска в консоли

![New Maven Project - Результаты запуска сценария](./_Files/2.%20New%20Project/45.jpg "New Project - Результаты запуска сценария")

## 9.2. С помощью раннер класса

Шаги:

1. Открыть файл **RunCucumberTest.java**

2. Проверить, что в **@CucumberOptions** заданы верные пути до **.feature** файлов и реализации шагов сценариев

3. Запустить сценарии

![New Maven Project - Запуск всех сценариев](./_Files/2.%20New%20Project/46.jpg "New Project - Запуск всех сценариев")

4. Получить результаты запуска в консоли

![New Maven Project - Результаты запуска сценария](./_Files/2.%20New%20Project/47.jpg "New Project - Результаты запуска сценария")

## 9.3. С помощью Maven

Шаги:

1. Проверить, что модуль **JUnit Vintage** подключен к проекту

**Cucumber** основан на **JUnit 4**.
Поэтому для запуска через **Maven** сценариев **Cucumber** с **JUnit5** обязательно нужно подключить
модуль **JUnit Vintage**.

В отличие от предыдущих версий **JUnit**, **JUnit 5** состоит из нескольких разных модулей.
Модуль **JUnit Vintage** предоставляет возможности для запуска тестов на основе **JUnit 3** и **JUnit 4**.

2. Запустить выполнение сценариев через команду **Maven**

При запуске считываются параметры (по приоритету) из:

* переменных среды 
* **-D** параметров 
* **@CucumberOptions**
* **junit-platform.properties**

* запуск всех сценариев

```shell
mvn clean test -Dtest=RunCucumberTest
```

или

```shell
mvn clean test
```

* запуск файла с фичами

```shell
mvn clean test -Dcucumber.features=src/test/resources/features/Smartphone.feature
```

3. Получить результаты запуска в консоли

![New Maven Project - Результаты запуска сценария](./_Files/2.%20New%20Project/48.jpg "New Project - Результаты запуска сценария")

***

[![Лекция](https://img.shields.io/badge/-Лекция-ee99ff)](1.%20Лекция.md)
[![Главная](https://img.shields.io/badge/-Главная-aaccee)](README.md)
[![Задание](https://img.shields.io/badge/-Задание-99ffee)](3.%20Задание.md)