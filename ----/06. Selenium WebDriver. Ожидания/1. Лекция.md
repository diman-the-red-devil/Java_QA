Java_QA / Level 1. Easy - Основы / 1.1. Selenium WebDriver / Урок 08. Ожидания

[![Содержание](https://img.shields.io/badge/-%D0%A1%D0%BE%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D0%BD%D0%B8%D0%B5-purple)](README.md)
[![Вперед](https://img.shields.io/badge/-%D0%92%D0%BF%D0%B5%D1%80%D0%B5%D0%B4-brightgreen)](2. Практика.md)

***

# 1. Как происходит загрузка страницы?

## 1.1. Поэтапный процесс загрузки веб страницы в браузере

Этапы загрузки веб страницы:

0. Пользователь открывает нужную страницу сайта в браузере (URL).

1. Обработка запросов к DNS-серверу.

Запрос к хосту, на котором размешен сайт со всеми файлами и папками.

***DNS (Domain Name System)*** — система доменных имён, компьютерная распределённая система для получения информации о доменах. 
Чаще всего используется для получения IP-адреса по имени хоста (компьютера или устройства), 
получения информации о маршрутизации почты, обслуживающих узлах для протоколов в домене (SRV-запись).

***DNS-сервер (name server)*** — приложение, предназначенное для ответов на DNS-запросы по соответствующему протоколу. 
Также DNS-сервером могут называть хост, на котором запущено приложение.

2. Обработка редиректов.

Время, которое будет потрачено на отработку HTTP-переадресации при загрузке страницы.

3. Подключение к серверу. 

Время, в течение которого браузер ожидает подключения к HTTP-серверу при получении содержимого страницы.

4. Ответ сервера.

Время, в течение которого передается ответ с содержимым страницы от HTTP-сервера к браузеру.

5. Обработка HTML.

Время, в течение которого браузер обрабатывает содержимое страницы после ее загрузки с сервера и до начала отрисовки.

6. Отрисовка браузером страницы

Время, которое пройдет от начала перехода на страницу до момента, когда страница начинает отрисовываться.

7. Полная загрузка

Время, которое пройдет от начала перехода на страницу до полной загрузки страницы со всеми ее компонентами 
(изображения, CSS, скрипты и т. п.). Это значение субъективно воспринимается посетителем как «качество» страницы.

![Этапы загрузки веб страниц](_Files/1.%20PageLoadStrategy/01.png "Этапы загрузки веб страниц")

## 1.2. Важные события жизненного цикла веб страницы

У жизненного цикла HTML страницы есть следующие события:

* *document.DOMContentLoaded* – браузер полностью загрузил HTML, было построено **DOM** дерево, но внешние ресурсы, 
  такие как картинки <img> и стили, могут быть ещё не загружены

**DOM** дерево готово, так что обработчик может искать **DOM**-узлы и инициализировать интерфейс.

* *window.onload* – браузер загрузил HTML и внешние ресурсы (картинки, стили и т.д.)

Внешние ресурсы были загружены, стили применены, размеры картинок известны и т.д - можно с ними работать.

* *window.onbeforeunload* – пользователь покидает страницу

* *window.onunload* - пользователь почти ушёл

### 1.2.1. Особенности события document.DOMContentLoaded

Событие **DOMContentLoaded** срабатывает на объекте **document**.
На первый взгляд событие **DOMContentLoaded** очень простое. 
DOM-дерево готово – получаем событие. Хотя тут есть несколько особенностей.

#### 1.2.1.1. DOMContentLoaded и скрипты

Когда браузер обрабатывает HTML-документ и встречает тег \<script\>, 
он должен выполнить его перед тем, как продолжить строить DOM. 
Это делается на случай, если скрипт захочет изменить **DOM** или даже дописать в него (**document.write**), 
так что **DOMContentLoaded** должен подождать.

Есть два исключения из этого правила:

* скрипты с атрибутом **async** не блокируют **DOMContentLoaded**
* скрипты, сгенерированные динамически при помощи **document.createElement('script')** и затем добавленные на страницу, 
также не блокируют это событие

#### 1.2.1.2. DOMContentLoaded и стили

Внешние таблицы стилей не затрагивают **DOM**, поэтому **DOMContentLoaded** их не ждёт.
Но здесь есть подводный камень. Если после стилей у нас есть скрипт, то этот скрипт должен дождаться, пока загрузятся стили
Причина в том, что скрипту может понадобиться получить координаты или другие свойства элементов, зависящих от стилей, как в примере выше. 
Естественно, он должен дождаться, пока стили загрузятся.
Так как **DOMContentLoaded** дожидается скриптов, то теперь он так же дожидается и стилей перед ними.

### 1.2.2. Свойство document.readyState

Свойство **document.readyState** показывает нам текущее состояние загрузки.

Есть три возможных значения:

* *loading* – документ загружается
  
* *interactive* – документ был полностью прочитан

Свойство **document.readyState** станет **interactive** прямо перед **DOMContentLoaded**. 
Эти две вещи, на самом деле, обозначают одно и то же.

* *complete* – документ был полностью прочитан и все ресурсы (такие как изображения) были тоже загружены 

Свойство **document.readyState** станет **complete**, когда все ресурсы загрузятся. 
Переключение на состояние **complete** означает то же самое, что и **window.onload**.
Разница заключается в том, что **window.onload** всегда срабатывает после всех load других обработчиков.

***

# 2. Стратегия загрузка страницы

## 2.1. Перечисление PageLoadStrategy

Можно настроить поведение при загрузке страницы, задав нужный параметр **PageLoadStrategy**.

***PageLoadStrategy*** - перечисление определяющее стратегии загрузки страницы.

Константы перечисления **PageLoadStrategy**

| Тип    | Описание                                                   | 
|--------|------------------------------------------------------------|
| NORMAL | Загрузка всей страницы (по умолчанию)                      |
| EAGER  | Загрузка только HTML части (без стилей, изображений и т д) |
| NONE   | Загрузки начальной страницы                                |

[selenium/docs/api : PageLoadStrategy](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/PageLoadStrategy.html)

### 2.1.1. PageLoadStrategy.NORMAL

Если установлено значение **PageLoadStrategy.NORMAL**, Selenium WebDriver ждет, 
пока не будет возвращено событие загрузки **window.onload**.

*Пример*

```java
ChromeOptions chromeOptions = new ChromeOptions();
chromeOptions.setPageLoadStrategy(PageLoadStrategy.NORMAL);
WebDriver driver = new ChromeDriver(chromeOptions);
driver.get("https://google.com");
```

### 2.1.2. PageLoadStrategy.EAGER

Если установлено значение **PageLoadStrategy.EAGER**, Selenium WebDriver ждет, 
пока не будет возвращено событие **document.DOMContentLoaded**.

*Пример*

```java
ChromeOptions chromeOptions = new ChromeOptions();
chromeOptions.setPageLoadStrategy(PageLoadStrategy.EAGER);
WebDriver driver = new ChromeDriver(chromeOptions);
driver.get("https://google.com");
```

### 2.1.3. PageLoadStrategy.NONE

Если установлено значение **PageLoadStrategy.NONE**, Selenium WebDriver ожидает только загрузки начальной страницы.

*Пример*

```java
ChromeOptions chromeOptions = new ChromeOptions();
chromeOptions.setPageLoadStrategy(PageLoadStrategy.NONE);
WebDriver driver = new ChromeDriver(chromeOptions);
driver.get("https://google.com");
```

***

# 3. Что такое ожидание?

***Ожидание*** - некий временной интервал между произведенными действиями 
(поиск элемента или любой другой вид операции с элементом).

Когда страница приложения загружена в браузере, элементы на этой странице могут подгружаться с различными временными интервалами.
Скрипт выполняется намного быстрее реакции приложения на команды.
Это затрудняет поиск элементов, если элемент не присутствует в **DOM**, возникает исключение **ElementNotVisibleException**.
Поэтому часто в скриптах необходимо дожидаться определенного состояния приложения для дальнейшего с ним взаимодействия.
Используя ожидания, мы можем решить эту проблему.
Таким образом ожидания нужны для синхронизации работы тестируемого приложения и тестового скрипта.

Так как **Selenium WebDriver** работает с **DOM**, то ожидание загрузки страницы происходит через ожидание состояния **document.readyState == complete**.
Это происходит автоматически после открытия страницы **driver.get()**, перезагрузки **driver.navigate.refresh()**,
перехода на другие страницы посредством нажатия на веб элементы и т.д.
**Selenium WebDriver** ожидает загрузку **DOM**-а страницы автоматически потому не нужно вызывать **waitForPageToLoad()**
после каждого действия, как это было в Selenium RC.

**Selenium WebDriver** предоставляет два типа ожиданий: 

* *неявные ожидания (Implicit Waits)* заставляют **Selenium WebDriver** опрашивать **DOM** определенное количество времени, когда пытается найти элемент
* *явные ожидания (Explicit Waits)* заставляют **Selenium WebDriver** ожидать возникновение определенного условия до произведения действий

![Ожидания (Waits)](_Files/2.%20Waits/01.jpg "Ожидания")

***

# 4. Неявные ожидания (Implicit Waits)

***Неявное ожидание (Implicit Waits)*** - ожидание, которое конфигурируют экземпляр WebDriver на совершение многократных попыток 
найти элемент (элементы) на странице в течении заданного периода времени, если элемент не найден сразу, и
только по истечении этого времени (по умолчанию 0) WebDriver бросит **ElementNotFoundException**. 

![Неявные ожидания (Implicit Waits)](_Files/3.%20Implicit%20Waits/01.jpg "Неявные ожидания (Implicit Waits)")

Неявные ожидания обычно настраиваются сразу после создания экземпляра **WebDriver** и действуют в течении всей жизни этого экземпляра, 
хотя переопределить их можно в любой момент. 

## 4.1. Интерфейс WebDriver.Options

Неявные ожидания настраиваются с помощью **WebDriver.Options**.

***WebDriver.manage()*** - реализация интерфейса **WebDriver.Options**.

Методы интерфейса **WebDriver.Options** для конфигурации неявных ожиданий:

| Тип                | Метод      | Описание                   | 
|--------------------|------------|----------------------------|
| WebDriver.Timeouts | timeouts() | Настройка неявных ожиданий |

[selenium/docs/api : WebDriver.Options](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/WebDriver.Options.html)

## 4.2. Интерфейс WebDriver.Timeouts

***WebDriver.Timeouts*** - интерфейс представляющий методы для настройки неявных ожиданий.

Методы интерфейса **WebDriver.Timeouts**:

| Тип                | Метод                               | Описание                                                                                    | 
|--------------------|-------------------------------------|---------------------------------------------------------------------------------------------|
| WebDriver.Timeouts | implicitlyWait(Duration duration)   | Настройка ожидания до появления элемента на странице (неявные ожидания)                     |
| WebDriver.Timeouts | pageLoadTimeout(Duration duration)  | Настройка ожидания до завершения загрузки страница перед появлением ошибки                  |
| WebDriver.Timeouts | setScriptTimeout(Duration duration) | Настройка ожидания до завершения выполнения асинхронного сценария перед появлением ошибки   |

[selenium/docs/api : Timeouts](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/WebDriver.Timeouts.html)

### 4.2.1. implicitlyWait(Duration duration)

Ожидание указывается глобально на уровне объекта **driver**. 
Все вызовы элементов **driver.findElement()** будут продолжаться то тех пор, 
пока элемент не будет найден или достигнута граница времени ожидания.
Если элемент не будет найден, то будет выброшено исключение **ElementNotFoundException**.

*Пример*

```java
WebDriver driver = new FirefoxDriver();
driver.manage().timeouts().implicitlyWait(10, TimeUnit.SECONDS);
driver.get("http://some_url");
WebElement dynamicElement = driver.findElement(By.id("dynamicElement_id"));
```

### 4.2.2. pageLoadTimeout(Duration duration)

Ожидание указывается для загрузки страницы.
Если **DOM** страницы не загрузился к тому моменту, то будет выброшено исключение **TimeoutException**.

*Пример*

```java
WebDriver driver = new FirefoxDriver();
driver.manage().timeouts().pageLoadTimeout(10, TimeUnit.SECONDS);
pageLoad();
```

### 4.2.3. setScriptTimeout(Duration duration)

Ожидание указывается для функции **executeAsyncScript** как граничное значение времени ожидания завершения запроса.
Если скрипт не завершится к тому времени, то будет выброшено исключение **TimeoutException**.

*Пример*

```java
WebDriver driver = new FirefoxDriver();
driver.manage().timeouts().setScriptTimeout(10, TimeUnit.SECONDS);
performScript();
```

## 4.3. Исключения

### 4.3.1. ElementNotFoundException

***ElementNotFoundException*** - исключение, которое вызывается, если веб элемент не найден в отведенный промежуток времени. 

### 4.3.2. TimeoutException

***TimeoutException*** - исключение, которое вызывается, когда выполнение какой-либо 
команды не завершилось в отведенный промежуток времени.

***

# 5. Явные ожидания (Explicit Waits)

***Явные ожидания (Explicit Waits)*** - ожидание, которое определяет какое необходимое событие должно произойти для того, 
чтобы дальнейший код исполнился. 

![Явные ожидания (Implicit Waits)](_Files/4.%20Explicit%20Waits/01.jpg "Неявные ожидания (Explicit Waits)")

Такое ожидание срабатывает один раз в указанном месте.

## 5.1. Интерфейс Wait<F>

**Wait** - интерфейс предоставляющий методы явных ожиданий.

Классы реализующие интерфейс:

* *FluentWait*
* *WebDriverWait*

Методы интерфейса **Wait**:

| Тип     | Метод                               | Описание                       |
|---------|-------------------------------------|--------------------------------|
| \<T\> T | until(Function<? super F,T> isTrue) | Ожидание определенного условия |	

[selenium/docs/api : Wait](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/support/ui/Wait.html)

## 5.2. Класс FluentWait

***FluentWait*** - класс реализующий явные ожидания, у которого время ожидания и интервал опроса могут быть настроены на лету.
Кроме того, пользователь может настроить ожидание так, чтобы игнорировать определенные типы исключений во время ожидания, 
такие как **NoSuchElementExceptions**, при поиске элемента на странице.

Класс реализует интерфейс **Wait**.

Методы класса **FluentWait**:

| Тип                                 | Метод                                                                    | Описание                                     |
|-------------------------------------|--------------------------------------------------------------------------|----------------------------------------------|
| <K extends Throwable> FluentWait<T> | ignoreAll(Collection<Class<? extends K>> exs)                            | Игнорирование исключений                     |
| FluentWait<T>	                      | ignoring(Class<? extends Throwable> ex)	                                 | Игнорирование исключения                     |                                                                                         |
| FluentWait<T>	                      | ignoring(Class<? extends Throwable> ex1, Class<? extends Throwable> ex2) | Игнорирование исключений                     |                                                                                          |
| FluentWait<T>	                      | pollingEvery(java.time.Duration interval)	                             | Частота опроса для проверки условий ожидания |
| protected RuntimeException	      | timeoutException(String message, Throwable lastException)                | Исключение по таймауту                       |
| <V> V	                              | until(Function<? super T,V> isTrue)	                                     | Ожидание определенного условия               |
| FluentWait<T>	                      | withMessage(String message)	                                             | Сообщение отображаемое по таймауту           |
| FluentWait<T>	                      | withMessage(Supplier<String> messageSupplier)	                         | Сообщение отображаемое по таймауту           |
| FluentWait<T>	                      | withTimeout(Duration timeout)             	                             | Интервал оценки условий ожидания             |

[selenium/docs/api : FluentWait](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/support/ui/FluentWait.html)

*Пример*

```java
driver = new ChromeDriver();
FluentWait<WebDriver> wait = new FluentWait<WebDriver>(driver)
  .withTimeout(7, TimeUnit.SECONDS)
  .pollingEvery(500, TimeUnit.MILLISECONDS)
  .ignoring(NoSuchElementException.class);

WebElement element = wait.until(new Function<WebDriver, WebElement>() {
  public WebElement apply(WebDriver driver)
  {
      return driver.findElement(locator);
  }
});
element.click();
```

## 5.3. Класс WebDriverWait

***WebDriverWait*** - класс реализующий явные ожидания.

Класс наследует класс **FluentWait**.
Класс реализует интерфейс **Wait**.

Конструкторы класса **WebDriverWait**:

| Конструктор                                                                                     | 
|-------------------------------------------------------------------------------------------------|
| WebDriverWait(WebDriver driver, Duration timeout)                                               |
| WebDriverWait(WebDriver driver, Duration timeout, Duration sleep)                               |
| WebDriverWait(WebDriver driver, Duration timeout, Duration sleep, Clock clock, Sleeper sleeper) |

Параметры конструкторов:

* driver - инстанс **WebDriver** 
* timeout - интервал в течение которого проверяется ожидаемое условие (посылаются запросы)
* sleep - интервал между посылаемыми запросами
* clock - экземпляр класса Clock (получение данных о текущем времени)
* sleeper - экземпляр класс Sleeper (обертка вокруг Thread.sleep())

[selenium/docs/api : WebDriverWait](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/support/ui/WebDriverWait.html)

*Пример*

```java
WebDriverWait wait = new WebDriverWait(driver, 10L, 125L);
wait.until(driver -> driver.findElements(By.cssSelector("div.super")).size() > 10);
```

## 5.4. Игнорирование определенных событий

Во время процесса поиска **WebDriver** регулярно опрашивает браузер на наличие элемента в **DOM** модели. 
При этом существует ряд исключительных ситуаций, которые могут возникнуть (см ниже).

Когда пойман один из таких случаев, то цикл остановится и выбросит исключение.
Для того чтобы игнорировать исключения предусмотрены методы **ignoring**:

```java
private final Wait<WebDriver> wait = new WebDriverWait(driver, 5)
        .ignoring(StaleElementReferenceException.class, ElementNotVisibleException.class);
```

## 5.5. Задержка Thread.sleep

Самым худшим вариантом явного ожидания является использование **Thread.sleep**, в
случае с которым скрипт просто будет ждать определенное количество времени.
Это не гарантирует наступление нужного события либо будет слишком избыточным и увеличит время выполнения теста.

*Пример*

```java
By xpath = By.xpath("//button")
WebElement element = driver.findElement(xpath);
element.click();
Thread.sleep(1000);
...
```

## 5.6. Исключения

### 5.6.1.ElementNotFoundException

***ElementNotFoundException*** - исключение, которое вызывается, если веб элемент не найден в отведенный промежуток времени.

### 5.6.2. TimeoutException

***TimeoutException*** - исключение, которое вызывается, когда выполнение какой-либо
команды не завершилось в отведенный промежуток времени.

### 5.6.3. StaleElementReferenceException

***StaleElementReferenceException*** - исключение, которое вызывается, если элемент доступен в **DOM** на момент поиска, 
но спустя время, в момент его вызова, **DOM** может измениться.

### 5.6.4. NoSuchElementException  

***NoSuchElementException*** - исключение, которое вызывается, если элемент отсутствует в **DOM** на момент вызова.

### 5.6.5. ElementNotVisibleException  

***ElementNotVisibleException*** - исключение, которое вызывается, если элемент был найдем в **DOM**, но он невидим на странице.

### 5.6.6. MoveTargetOutOfBoundsException

***MoveTargetOutOfBoundsException*** - исключение, которое вызывается, если элемент изменил координаты.

***

# 6. Ожидаемые условия

Явные ожидания требуют наступления определенных условий.

## 6.1. Интерфейс ExpectedCondition<T>

***ExpectedCondition<T>*** - интерфейс моделирующий ожидаемое условие.

Интерфейс реализует следующие интерфейсы:

* **com.google.common.base.Function<WebDriver, T>**
* **java.util.function.Function<WebDriver, T>**

[selenium/docs/api : ExpectedCondition](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/support/ui/ExpectedCondition.html)

## 6.2. Класс ExpectedConditions

Существуют некие условия, которые часто встречаются при автоматизации.

***ExpectedConditions*** - класс представляющий часто встречающиеся условия ожидания.

Класс реализует интерфейс **ExpectedCondition**.

Методы класса **ExpectedConditions**:

* *атрибуты и свойства элементов*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<Boolean>          | attributeContains(By by, String attr, String val)         | Атрибут элемента содержит значение      |
| ExpectedCondition<Boolean>          | attributeContains(WebElement el, String attr, String val) | Атрибут элемента содержит значение      |
| ExpectedCondition<Boolean>          | attributeToBe(By by, String attr, String val)             | Атрибут элемента равен значению         |
| ExpectedCondition<Boolean>          | attributeToBe(WebElement el, String attr, String val)     | Атрибут элемента равен значению         |
| ExpectedCondition<Boolean>          | attributeToBeNotEmpty(WebElement el, String attr)         | Атрибут элемента не пустой              |
| ExpectedCondition<Boolean>          | domAttributeToBe(WebElement el, String attr, String val)  | DOM атрибут элемента равен значению     |
| ExpectedCondition<Boolean>          | domPropertyToBe(WebElement el, String prop, String val)   | DOM свойство элемента равно значению    |

* *состояние элементов*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<WebElement>       | elementToBeClickable(By by)                               | Возможность кликнуть на элемент         |
| ExpectedCondition<WebElement>       | elementToBeClickable(WebElement el)                       | Возможность кликнуть на элемент         |
| ExpectedCondition<Boolean>          | elementToBeSelected(By by)                                | Возможность выбрать элемент             |
| ExpectedCondition<Boolean>          | elementToBeSelected(WebElement el)                        | Возможность выбрать элемент             |
| ExpectedCondition<Boolean>          | elementSelectionStateToBe(By by, boolean state)           | Состояние выбираемого элемента          |
| ExpectedCondition<Boolean>          | elementSelectionStateToBe(WebElement el, boolean state)   | Состояние выбираемого элемента          |

* *количество элементов*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<List<WebElement>> | numberOfElementsToBe(By by, Integer number)               | Количество элементов равно заданному    |
| ExpectedCondition<List<WebElement>> | numberOfElementsToBeLessThan(By by, Integer number)       | Количество элементов меньше заданного   |
| ExpectedCondition<List<WebElement>> | numberOfElementsToBeMoreThan(By by, Integer number)       | Количество элементов больше заданного   |

* *наличие элементов*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<WebElement>       | presenceOfElementLocated(By by)                           | Наличие элемента                        |
| ExpectedCondition<List<WebElement>> | presenceOfAllElementsLocatedBy(By by)                     | Наличие элементов                       |
| ExpectedCondition<WebElement>       | presenceOfNestedElementLocatedBy(By pr, By ch)            | Наличие вложенного элемента в элемент   |
| ExpectedCondition<WebElement>       | presenceOfNestedElementLocatedBy(WebElement pr, By ch)    | Наличие вложенного элемента в элемент   |
| ExpectedCondition<List<WebElement>> | presenceOfNestedElementsLocatedBy(By pr, By ch)           | Наличие вложенных элементов в элемент   |

* *отсутствие элементов*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<Boolean>          | stalenessOf(WebElement el)                                | Отсутствие элемента                     |

* *видимость элементов*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<WebElement>       | visibilityOf(WebElement el)                               | Видимость элемента                      |
| ExpectedCondition<List<WebElement>> | visibilityOfAllElements(List<WebElement> els)             | Видимость всех элементов                |
| ExpectedCondition<List<WebElement>> | visibilityOfAllElements(WebElement... els)                | Видимость всех элементов                |
| ExpectedCondition<List<WebElement>> | visibilityOfAllElementsLocatedBy(By by)                   | Видимость всех элементов                |
| ExpectedCondition<WebElement>       | visibilityOfElementLocated(By by)                         | Видимость элемента                      |
| ExpectedCondition<List<WebElement>> | visibilityOfNestedElementsLocatedBy(By pr, By ch)         | Видимость вложенных элементов в элемент |
| ExpectedCondition<List<WebElement>> | visibilityOfNestedElementsLocatedBy(WebElement pr, By ch) | Видимость вложенных элементов в элемент |

* *невидимость элементов*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<Boolean>          | invisibilityOf(WebElement el)                             | Невидимость элемента                    |
| ExpectedCondition<Boolean>          | invisibilityOfAllElements(List\<WebElement\> els)         | Невидимость всех элементов              |
| ExpectedCondition<Boolean>          | invisibilityOfAllElements(WebElement... els)              | Невидимость всех элементов              |
| ExpectedCondition<Boolean>          | invisibilityOfElementLocated(By by)                       | Невидимость элемента                    |
| ExpectedCondition<Boolean>          | invisibilityOfElementWithText(By by, String text)         | Невидимость элемента с текстом          |

* *текстовое содержимое элементов*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<Boolean>          | textMatches(By by, Pattern pattern)                       | Текст в элементе совпадает с паттерном  |
| ExpectedCondition<Boolean>          | textToBe(By by, String value)                             | Текст в элементе равен заданному        | 
| ExpectedCondition<Boolean>          | textToBePresentInElement(WebElement el, String text)      | Текст в элементе равен заданному        |
| ExpectedCondition<Boolean>          | textToBePresentInElementLocated(By by, String text)       | Текст в элементе равен заданному        |
| ExpectedCondition<Boolean>          | textToBePresentInElementValue(By by, String text)         | Текст в элементе равен заданному        |
| ExpectedCondition<Boolean>          | textToBePresentInElementValue(WebElement el, String text) | Текст в элементе равен заданному        |

* *работа со страницей*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<Boolean>          | titleContains(String title)                               | Заголовок содержит текст                |
| ExpectedCondition<Boolean>          | titleIs(String title)                                     | Заголовок равен заданному               |
| ExpectedCondition<Boolean>          | urlContains(String fraction)                              | URL содержит текст                      |
| ExpectedCondition<Boolean>          | urlMatches(String regex)                                  | URL совпадает по регулярному выражению  |
| ExpectedCondition<Boolean>          | urlToBe(String url)                                       | URL равен заданному                     |
| static <T> ExpectedCondition<T>     | refreshed(ExpectedCondition<T> condition)                 | Обновление страницы                     |

* *работа с алертами*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<Alert>            | alertIsPresent()                                          | Появление алерта на странице            |

* *работа с фреймами*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<WebDriver>        | frameToBeAvailableAndSwitchToIt(int frame)                | Доступность фрейма для переключения     |
| ExpectedCondition<WebDriver>        | frameToBeAvailableAndSwitchToIt(String locator)           | Доступность фрейма для переключения     |
| ExpectedCondition<WebDriver>        | frameToBeAvailableAndSwitchToIt(By by)                    | Доступность фрейма для переключения     |
| ExpectedCondition<WebDriver>        | frameToBeAvailableAndSwitchToIt(WebElement el)            | Доступность фрейма для переключения     |

* *работа с окнами*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<Boolean>          | numberOfWindowsToBe(int windows)                          | Количество окон равно заданному         |

* *работа с JS скриптом*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<Boolean>          | javaScriptThrowsNoExceptions(String script)               | JS скрипт не выбрасывает исключение     |
| ExpectedCondition<Object>           | jsReturnsValue(String script)                             | JS скрипт возвращает значение           |

* *логические операции*

| Тип                                 | Метод                                                     | Описание                                |
|-------------------------------------|-----------------------------------------------------------|-----------------------------------------|
| ExpectedCondition<Boolean>          | and(ExpectedCondition\<?\>... conditions)                 | Логическое условие **И**                |
| ExpectedCondition<Boolean>          | or(ExpectedCondition\<?\>... conditions)                  | Логическое условие **ИЛИ**              |
| ExpectedCondition<Boolean>          | not(ExpectedCondition\<?\> condition)                     | Логическое условие **НЕ**               |

[selenium/docs/api : ExpectedConditions](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/support/ui/ExpectedConditions.html)

*Пример*

```java
By xpath = By.xpath("//button")
WebElement element = driver.findElement(xpath);
element.click();
WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));
wait.until(ExpectedConditions.elementToBeClickable(element));
```

## 6.3. Кастомные условия ожидания

Встроенные условия ожидания (**ExpectedConditions**) не всегда способны удовлетворить потребности автотеста.
В таких случаях можно написать собственные методы, которые удержат автотесты от падения.
Работать кастомные ожидания будут по тому же принципу, что и встроенные **ExpectedConditions**.

Для написания своих условий ожидания необходимо создать класс (именованный или анонимный) реализующий интерфейс **ExpectedCondition**.

### 6.3.1. Кастомные условия ожидания с использованием именованного класса

Можно создать отдельный именованный класс реализующий интерфейс **ExpectedCondition**.
И далее использовать его в коде автотеста.

*Пример*

```java
private class ElementContainsText implements ExpectedCondition<Boolean> {

    private By findBy;    
    private String textToFind;
    
    public ElementContainsText (final By elementFindBy, final String textToFind) {
        this.findBy = elementFindBy;
        this.textToFind = textToFind;
    }
    
    @Override
    public Boolean apply(WebDriver webDriver) {
        WebElement element = webDriver.findElement(this.findBy);
        if (element.getText().contains(this.textToFind)) { 
            return true;
        } else {
            return false;
        }
    }
    
    @Override
    public String toString() {
        return ": \"Does " + this.findBy + " contain " + this.textToFind + "?\"";
    }
}
```

### 6.3.2. Кастомные условия ожидания с использованием анонимного класса

Можно применить анонимный класс реализующий интерфейс **ExpectedCondition** прямо в коде автотеста.

*Пример*

```java
wait.until((ExpectedCondition<Boolean>) webDriver -> {
    return webDriver
        .findElement(By.xpath("//div/button[@id='btn1']"))
        .getText()
        .contains(String.valueOf(year));
});
```

***

# 7. Сравнение явных и неявных ожиданий

|            | Неявные                  | Явные                   |
|------------|--------------------------|-------------------------|
| Проверка   | На стороне браузера      | На стороне клиента      |
| Событие    | Ожидание появления в DOM | Ждать можно чего угодно |
| Применение | Ко всем элементам        | К конкретному элементу  |
| Исключение | NoSuchElementException   | TimeoutException        |
| Режим      | Работают автоматически   | Надо писать явно        |
| Запросы    | Один сетевой запрос      | Много сетевых запросов  |

***

[TO DO]
Как победить staleness?
• Поиск элемента перед использованием
• Выбор подходящего момента для действия
• Повторные попытки после исключения
• А может быть не только staleness?

***

Практика [![Перейти](https://img.shields.io/badge/-%D0%9F%D0%B5%D1%80%D0%B5%D0%B9%D1%82%D0%B8-blue)](2.%20Практика.md)