Java_QA / 07. Selenium WebDriver. Окна

[![Содержание](https://img.shields.io/badge/-%D0%A1%D0%BE%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D0%BD%D0%B8%D0%B5-purple)](README.md)
[![Вперед](https://img.shields.io/badge/-%D0%92%D0%BF%D0%B5%D1%80%D0%B5%D0%B4-brightgreen)](2.%20Практика.md)

***

# 1. Какие бывают окна?

## 1.1. Объектная модель браузера (Browser Object Model, BOM)

Веб-страницы бывают статическими и динамическими, последние отличаются тем, что в них используются сценарии (программы) на языке **JavaScript**.

Язык **JavaScript** изначально был создан для веб-браузеров. 
Но с тех пор он значительно эволюционировал и превратился в кроссплатформенный язык программирования для решения широкого круга задач.

Сегодня **JavaScript** может использоваться в браузере, на веб-сервере или в какой-то другой среде, даже в кофеварке. 
Каждая среда предоставляет свою функциональность, которую спецификация **JavaScript** называет **окружением**.
**Окружение** предоставляет свои объекты и дополнительные функции, в дополнение базовым языковым. 
Браузеры, например, дают средства для управления веб-страницами.

![Браузерное окружение](./_Files/1.%20SwitchTo/01.png "Браузерное окружение")

***Объектная модель браузера (Browser Object Model, BOM)*** – дополнительные объекты, предоставляемые браузером (окружением),
чтобы работать со всем, кроме документа.

![Объектная модель браузера](./_Files/1.%20SwitchTo/02.png "Объектная модель браузера")

## 1.2. Объект window

***window*** – самый главный (глобальный) объект в браузере, 
расположенный на самом верху **Объектной модели браузера**, который отвечает за одно из окон (вкладок) браузера 
и является корнем иерархии всех объектов доступных веб-разработчику в сценариях **JavaScript**.

Он представляет собой одно из окон или вкладку браузера с его панелями инструментов, 
меню, строкой состояния, HTML страницей и другими объектами.

Объект **window** кроме глобальных объектов (document, screen, location, navigator и др.) имеет собственные свойства и методы.

## 1.3. Виды окон в браузере

### 1.3.1. Окна и вкладки

***Окно браузера*** - форма графического интерфейса.
Во всех существующих браузерах представляется в форме прямоугольного поля, в котором отображается текст, картинки, видеозаписи и т д.

***Вкладка браузера*** – отдельно открытая веб-страница (сайт) в браузере. 

Если в браузере открыть несколько вкладок (окон), то браузером будет создано столько объектов **window**,
сколько открыто этих вкладок (окон). Т.е. каждый раз открывая вкладку (окно),
браузер создаёт новый объект **window** связанный с этой вкладкой (окном).

![Окна и вкладки](./_Files/1.%20SwitchTo/03.jpg "Окна и вкладки")

***Дескриптор окна*** - уникальный идентификатор окно, специальное значение,
которое операционная система присваивает каждому создаваемому окну.
Прикладная программа использует этот дескриптор в своих функциях, чтобы направить действие на это окно.

### 1.3.2. Модальные окна

У браузеров есть возможность взаимодействия с пользователем, через диалоговые (модальные) окна на **JavaScript**.
Достигается это с помощью встроенных в браузер функций: **alert**, **prompt** и **confirm**.
Диалоговые окна создаваемые этими методами являются модальными. Это значит, что они блокируют доступ пользователя
к остальной части страницы пока оно не будет закрыто. Кроме этого, они ещё приостанавливают загрузку дальнейшей части страницы.

#### 1.3.2.1. Alert

Функция **alert** предназначена для вывода в браузере модального диалогового окна с некоторым сообщением и кнопкой **ОК**.

Функция **alert** используется для предупреждения пользователя о чем-то важном.
Например, чтобы он не покидал страницу, иначе, введенные им данные не будут сохранены.

*Пример*

```js
function myFunction() {
    alert("I am an alert box!");
}
```

![Модальные окна. Alert](./_Files/1.%20SwitchTo/04.jpg "Модальные окна. Alert")

#### 1.3.2.2. Prompt

Функция **prompt** предназначена для вывода в браузере модального диалогового окна с сообщением, 
текстовым полем для ввода данных и кнопками **ОК** и **Отмена**.

Функция **prompt** используется для запроса данных, которые пользователю нужно ввести в текстовое поле.
Например, возраст.

*Пример*

```js
function myFunction() {
    var name = prompt("I am a prompt box! What is your name?");
    alert("Hello " + name + "!");
}
```

![Модальные окна. Prompt](./_Files/1.%20SwitchTo/05.jpg "Модальные окна. Prompt")

#### 1.3.2.3. Confirm

Функция **confirm** предназначен для вывода в браузере модального диалогового окна с сообщением и кнопками **ОК** и **Отмена**.

Функция **confirm** используется для того, чтобы получить от пользователя ответ **ДА** или **НЕТ**.
В зависимости от ответа команда confirm возвращает булевы значения **true** или **false**.
Например, подтверждения отправки данных.

*Пример*

```js
function myFunction() {
    const result = confirm("I am a confirm box! Continue?");
}
```

![Модальные окна. Confirm](./_Files/1.%20SwitchTo/06.jpg "Модальные окна. Confirm")

### 1.3.3. Фреймы

***Фрейм*** - отдельный законченный **HTML**-документ, содержащий свою собственную модель страницы (**DOM**).

***Плавающий фрейм (iframe, inline frame)***, или еще его ***называют встроенный фрейм***,
может встраиваться в любое место HTML-страницы.
Для каждого тега \<iframe\> в HTML документе создается **iFrame** объект и
позволяет загружать в область заданных размеров любые другие независимые документы.

![Фреймы](./_Files/1.%20SwitchTo/07.jpg "Фреймы")

### 1.3.4. Кастомные попапы

***Кастомные попапы*** - всплывающие окна написанные на **HTML** и **CSS** и могут выглядеть как всплывающие окна **JavaScript** или
всплывающее окно уровня ОС, но на самом деле это просто **HTML** код, отображаемый поверх текущей страницы.

![Кастомные попапы](./_Files/1.%20SwitchTo/08.jpg "Кастомные попапы")

***

# 2. Окна и вкладки

## 2.1. Интерфейс WebDriver

***WebDriver*** - интерфейс для управления драйвером браузера.

Методы интерфейса **WebDriver** для работы с окнами:

| Тип               | Метод              | Описание                                               |
|-------------------|--------------------|--------------------------------------------------------|
| String            | getWindowHandle()  | Получение дескриптора текущего открытого окна браузера |
| Set<String>       | getWindowHandles() | Получение дескрипторов всех окон браузера              |
| WebDriver.Options | manage()           | Управление свойствами и настройками браузера           |

[selenium/docs/api : WebDriver](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/WebDriver.html)

*Пример*

```java
WebDriver driver = new ChromeDriver();
String window = driver.getWindowHandle();
Set<String> windows = driver.getWindowHandles();
```

## 2.2. Интерфейс WebDriver.Options

***WebDriver.Options*** - интерфейс для управления настройками браузера.

***WebDriver.manage()*** - реализация интерфейса **WebDriver.Options**.

Методы интерфейса **WebDriver.Options** для управления настройками браузера:

| Тип              | Метод    | Описание                | 
|------------------|----------|-------------------------|
| WebDriver.Window | window() | Настройка окон браузера |

[selenium/docs/api : WebDriver.Options](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/WebDriver.Options.html)

## 2.3. Интерфейс WebDriver.Window

***WebDriver.Window*** - интерфейс представляющий настройки текущего окна браузера.

***WebDriver.manage().window()*** - реализация интерфейса **WebDriver.Window**.

Методы интерфейса **WebDriver.Window**:

| Тип       | Метод                             | Описание                                                             | 
|-----------|-----------------------------------|----------------------------------------------------------------------|
| void      | fullscreen()                      | Перевод в полноэкранный режим текущего окна                          |
| void      | maximize()                        | Максимизация размеров текущего окна                                  |
| void      | minimize()                        | Минимизация размеров текущего окна                                   |
| Point     | getPosition()                     | Получение координат текущего окна отн-но верхнего левого угла экрана |
| Dimension | getSize()                         | Получение размеров текущего окна                                     |
| void      | setPosition(Point targetPosition) | Установка координат текущего окна                                    |
| void      | setSize(Dimension targetSize)     | Установка размеров текущего окна                                     |

[selenium/docs/api : WebDriver.Window](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/WebDriver.Window.html)

### 2.3.1. Перевод в полноэкранный режим текущего окна

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.get("https://devqa.io/");
driver.manage().window().fullscreen();
```

### 2.3.2. Максимизация и минимизация размеров текущего окна

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.get("https://devqa.io/");
driver.manage().window().maximize();
Point positionAfterMaximize = driver.manage().window().getPosition();
Dimension sizeAfterMaximize = driver.manage().window().getSize();
driver.manage().window().minimize();
Point positionAfterMinimize = driver.manage().window().getPosition();
Dimension sizeAfterMinimize = driver.manage().window().getSize();
```

### 2.3.3. Установка и получение координат текущего окна

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.get("https://devqa.io/");
Point positionBefore = driver.manage().window().getPosition();
Point newPosition = new Point(200, 200);
driver.manage().window().setPosition(newPosition);
Point positionAfterMaximize = driver.manage().window().getPosition();
```

### 2.3.4. Установка и получение размеров текущего окна

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.get("https://devqa.io/");
Dimension sizeBefore = driver.manage().window().getSize();
Dimension newSize = new Dimension(1520, 680);
driver.manage().window().setSize(newSize);
Dimension sizeAfterMaximize = driver.manage().window().getSize();
```

## 2.4. Класс Point

***Point*** - класс представляющий точку с координатами x и y в пространстве.

Методы класса **Point**:

| Тип   | Метод                            | Описание                                 | 
|-------|----------------------------------|------------------------------------------|
| int   | getX()                           | Получение координаты x                   |
| int   | getY()                           | Получение координаты y                   |
| void  | move(int newX, int newY)         | Перемещение в точку с координатами x и y |
| Point | moveBy(int xOffset, int yOffset) | Перемещение в точку с отступами по x и y |

[selenium/docs/api : Point](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/Point.html)

*Пример*

```java
WebDriver driver = new ChromeDriver();
int x = driver.manage().window().getPosition().getX();
int y = driver.manage().window().getPosition().getY();
```

## 2.5. Класс Dimension

***Dimension*** - класс размеры окна по x и y.

Методы класса **Dimension**:

| Тип   | Метод       | Описание                        | 
|-------|-------------|---------------------------------|
| int   | getHeight() | получение размера по x (ширина) |
| int   | getWidth()  | получение размера по y (высота) |

[selenium/docs/api : Dimension](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/Dimension.html)

*Пример*

```java
WebDriver driver = new ChromeDriver();
int w = driver.manage().window().getSize().getWidth();
int h = driver.manage().window().getSize().getHeight();
```

***

# 3. Модальные окна

**Selenium** располагает встроенными средствами для работы с модальными диалоговыми окнами.
Для этих целей существует интерфейс **Alert**.

## 3.1. Интерфейс Alert

***Alert*** - интерфейс для взаимодействия с модалками.

Методы интерфейса **Alert**:

| Тип    | Метод                       | Описание                         | 
|--------|-----------------------------|----------------------------------|
| void	 | accept()	                   | Нажатие кнопки "Ок"              |
| void	 | dismiss()	               | Нажатие кнопки "Отмена"          |
| String | getText()	               | Получение текста модалки         |
| void	 | sendKeys(String keysToSend) | Ввод текста в поле ввода модалки |

[selenium/docs/api : WebDriver.TargetLocator](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/Alert.html)

*Пример*

```java
WebDriver driver = new ChromeDriver();
Alert alert = driver.switchTO().alert()
alert.getText();
alert.sendKeys("Text");
alert.accept();
```

## 3.2. Перечисление UnexpectedAlertBehaviour

***UnexpectedAlertBehaviour*** - перечисление определяющее поведение модалок.

Константы перечисления **UnexpectedAlertBehaviour**:

| Тип                | Описание               | 
|--------------------|------------------------|
| ACCEPT             | Принять                |
| ACCEPT_AND_NOTIFY  | Принять и уведомить    |
| DISMISS            | Отклонить              |
| DISMISS_AND_NOTIFY | Отклонить и уведомить  |
| IGNORE             | Игнорировать           |

[selenium/docs/api : UnexpectedAlertBehaviour](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/UnexpectedAlertBehaviour.html)

*Пример*

```java
ChromeOptions options = new ChromeOptions();
options.setCapability(
        CapabilityType.UNEXPECTED_ALERT_BEHAVIOUR, 
        UnexpectedAlertBehaviour.DISMISS);
ChromeDriver driver = new ChromeDriver(options);
```

***

# 4. Фреймы

Поиск элементов в **Selenium** осуществляется опираясь на **DOM**-модель. 
По умолчанию это всегда **DOM** текущей страницы. 
Для того, чтобы начать работать с контентом фрейма нужно указать драйверу с какой **DOM**-моделью необходимо работать.
Для этого нужно переключиться в фрейм (см далее).

В остальном же работа с веб элементами фрейма ни чем не отличается от работы с веб элементами текущей страницы.

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.get("https://demoqa.com/frames");
driver.switchTo().frame(0);
WebElement frame1Heading= driver.findElement(By.id("sampleHeading"));
String frame1Text = frame1Heading.getText();
System.out.println(frame1Text);
```

***

# 5. Кастомные попапы

В связи с тем, что кастомные попапы являются обычным **HTML**, 
взаимодействовать с ними можно так же, как с любым другим веб элементом текущей страницы. 

*Пример*

```java
ChromeOptions options = new ChromeOptions();
options.setCapability(
        CapabilityType.UNEXPECTED_ALERT_BEHAVIOUR, 
        UnexpectedAlertBehaviour.DISMISS);
ChromeDriver driver = new ChromeDriver(options);
```

***

# 6. Переключения

В некоторых кейсах появляется необходимость в переключении на другую вкладку, окно, фрейм и т д.
Для этого в **Selenium WebDriver** есть специальный интерфейс **WebDriver.TargetLocator**.

## 6.1. Интерфейс WebDriver

***WebDriver*** - интерфейс для управления драйвером браузера.

Методы интерфейса **WebDriver** для переключения между окнами браузера:

| Тип                     | Метод      | Описание                           | 
|-------------------------|------------|------------------------------------|
| WebDriver.TargetLocator | switchTo() | Переключение между окнами браузера |

[selenium/docs/api : WebDriver](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/WebDriver.html)

## 6.2. Интерфейс WebDriver.TargetLocator

***WebDriver.TargetLocator*** - интерфейс для переключения.

***WebDriver.switchTo()*** - реализация интерфейса **WebDriver.TargetLocator**.

Методы интерфейса **WebDriver.TargetLocator**:

| Тип        | Метод                          | Описание                                                                                            | 
|------------|--------------------------------|-----------------------------------------------------------------------------------------------------|
| WebElement | activeElement()                | Переключение на текущий активный элемент (в фокусе)                                                 |
| Alert	     | alert()                        | Переключение на текущее активное модальное окно                                                     |
| WebDriver	 | defaultContent()               | Переключение на первый фрейм на странице или основной документ, если страница содержит фреймы       | 
| WebDriver	 | frame(int index)               | Переключение на фрейм по его индексу отчитываемому от нуля                                          |  
| WebDriver	 | frame(String nameOrId)         | Переключение на фрейм по его имени или айди                                                         |
| WebDriver	 | frame(WebElement frameElement) | Переключение на фрейм по элементу                                                                   |
| WebDriver	 | newWindow(WindowType typeHint) | Создание нового окна браузера и переключение на него (для выполнения всех последующих команд)       |
| WebDriver	 | parentFrame()                  | Переключение на родительский контекст                                                               |
| WebDriver	 | window(String nameOrHandle)    | Переключение на окно браузера по его имени или дескриптору (для выполнения всех последующих команд) |

[selenium/docs/api : WebDriver.TargetLocator](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/WebDriver.TargetLocator.html)

### 6.2.1. Переключение на окна / вкладки

Для переключения между окнами / вкладками браузера в **Selenium WebDriver** используется методы **window** и **newWindow**.

#### 6.2.1.1. Переключение на существующее окно / вкладку

Для окон нет родительского окна, в которое можно было бы переключиться по умолчанию.
Для переключения всегда используется **дескриптор окна**, поэтому для того,
чтобы переключиться в первоначально открытое окно, нужно сначала запомнить его **дескриптор**.

*Пример*

```java
Set<String> oldWindowsSet = driver.getWindowHandles();
driver.findElement(By.tagName("a")).click();
Set<String> newWindowsSet = driver.getWindowHandles();
newWindowsSet.removeAll(oldWindowsSet);
String newWindow = newWindowsSet.iterator().next();
driver.switchTo().window(newWindow);
```

#### 6.2.1.2. Переключение на новое созданное окно / вкладку

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.switchTo().newWindow(WindowType.WINDOW);
```

### 6.2.2. Переключение на модальное окно

Для переключения на модальное окно в **Selenium WebDriver** используется метод **alert**.
После переключения на модалку, с ней можно выполнить методы **Alert**.

*Пример*

```java
WebDriver driver = new ChromeDriver();
Alert alert = driver.switchTO().alert()
alert.getText();
alert.sendKeys("Text");
alert.accept();
```

### 6.2.3. Переключение на фрейм

Как уже упоминалось выше, поиск элементов в **Selenium WebDriver** осуществляется опираясь 
на **DOM** модель (по умолчанию, это всегда **DOM** нашей страницы).
А для того, чтобы начать работать с контентом фрейма нужно указать драйверу с какой **DOM** моделью необходимо работать.

#### 6.2.3.1. Переключение из текущей страницы на фрейм

Для переключения из текущей страницы на фрейм используется метод **frame**.

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.switchTo().frame(0);
driver.switchTo().frame("frameName");
WebElement iframe = driver.findElement(By.id("theFrame"));
driver.switchTo().frame(iframe);
```

Все фреймы определяются относительно текущего выбранного фрейма.
Из фрейма можно переключиться:

* во вложенный фрейм используя метод **frame**
* в родительский фрейм используя метод **parentFrame**
* в самый верхний уровень иерархии (к модели страницы браузера) используя метод **defaultContent**

#### 6.2.3.2. Переключение из фрейма во вложенный фрейм

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.switchTo().frame("frame01");
driver.switchTo().frame("frame12");
```

#### 6.2.3.3. Переключение из фрейма в родительский фрейм

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.switchTo().frame("frame01");
driver.switchTo().frame("frame12");
driver.switchTo().parentFrame();
```

#### 6.2.3.4. Переключение из фрейма в самый верхний уровень иерархии

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.switchTo().defaultContent();
```

#### 6.2.3.5. Доступ к дочерним фреймам

Можно получить доступ к дочерним фреймам путем:

* сцепления вызовов **switchTo()**

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.switchTo().frame("frame")
      .switchTo().frame("subFrame")
      .switchTo().frame("subSubFrame");
```

* разделения пути точкой

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.switchTo().frame("frame.subFrame.subSubFrame");
```

### 6.2.4. Переключение на активный элемент

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.switchTO().activeElement();
```

## 6.3. Перечисление WindowType

***WindowType*** - перечисление определяющее тип окна.

Константы перечисления **WindowType**:

| Тип    | Описание | 
|--------|----------|
| TAB    | Вкладка  |
| WINDOW | Окно     |

[selenium/docs/api : WindowType](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/WindowType.html)

## 6.4. Исключения

### 6.4.1. StaleElementReferenceException

***StaleElementReferenceException*** - исключение, которое возникает, когда ссылка на элемент больше не действительна.

### 6.4.2. NoSuchWindowException

***NoSuchWindowException*** - исключение, которое возникает при попытке переключиться на окно, 
если окна с заданным именем не найдено. 

*Пример*

```java
protected void safeSwitchToWindow(String windowName) {
    try {
        driver.switchTo().window(windowName);
    } catch (NoSuchWindowException e) {
    //...
    }
}
```

### 6.4.3. NoAlertPresentException

***NoAlertPresentException*** - исключение, которое возникает при попытке переключиться на модалку, 
если модалка не найдена.

*Пример*

```java
protected void safeAlertDissmiss() {
    try {
        driver.switchTo().alert().dismiss();
    } catch (NoAlertPresentException e) {
    //...
    }
}
```

Безопасно дождаться появления алерта на странице можно используя готовые функции класса **ExpectedConditions**.

*Пример*

```java
WebDriver driver = new FirefoxDriver();
Alert alert = (new WebDriverWait(driver, 10))
        .until(ExpectedConditions.alertIsPresent());
```

### 6.4.4. NoSuchFrameException

***NoSuchFrameException*** - исключение, которое возникает при попытке переключиться на фрейм, 
если фрейм с заданным параметром не найден.

*Пример*

```java
protected void safeSwitchToFrame(int frameIndex) {
    try {
        driver.switchTo().frame(frameIndex);
        // driver.switchTo().frame(frameName);
    } catch (NoSuchFrameException e) {
    //...
    }
}
```

***

# 7. Навигация

## 7.1. Интерфейс WebDriver

Методы интерфейса **WebDriver**:

| Тип                  | Метод      | Описание                     | 
|----------------------|------------|------------------------------|
| WebDriver.Navigation | navigate() | Управление историей браузера |

[selenium/docs/api : WebDriver](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/WebDriver.html)

## 7.2. Интерфейс WebDriver.Navigation

***WebDriver.Navigation*** - интерфейс для управления историей браузера (навигацией).

***WebDriver.navigate()*** - реализация интерфейса **WebDriver.Navigation**.

Методы интерфейса **WebDriver.Navigation**:

| Тип  | Метод          | Описание                             | 
|------|----------------|--------------------------------------|
| void | back()         | Перейти Назад на предыдущую страницу |
| void | forward()      | Перейти Вперед на следующую страницу |
| void | refresh()      | Обновить страницу                    |
| void | to(String url) | Загрузить новую страницу             |
| void | to(URL url)    | Загрузить новую страницу             |

[selenium/docs/api : WebDriver.Navigation](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/WebDriver.Navigation.html)

*Пример*

```java
WebDriver driver = new ChromeDriver();
driver.navigate().to("https://devqa.io");
driver.navigate().to("https://devqa.io/1");
driver.navigate().back();
driver.navigate().forward();
```

***

Практика [![Перейти](https://img.shields.io/badge/-%D0%9F%D0%B5%D1%80%D0%B5%D0%B9%D1%82%D0%B8-blue)](2.%20Практика.md)