# Java_QA / Level 1. Easy - Основы / 1.1. Selenium WebDriver / Урок 10. Протоколирование

[![Содержание](https://img.shields.io/badge/-%D0%A1%D0%BE%D0%B4%D0%B5%D1%80%D0%B6%D0%B0%D0%BD%D0%B8%D0%B5-purple)](README.md)
[![Вперед](https://img.shields.io/badge/-%D0%92%D0%BF%D0%B5%D1%80%D0%B5%D0%B4-brightgreen)](2.%20Практика.md)

***

# 1. Для чего нужно протоколирование?



***

# 2. Логи

***Логирование*** — запись в логи данных о работе программы (сервера, веб приложения и т д).

***Логи*** — файлы (обычно текстовые файлы), содержащие информацию о работе программы (сервера, веб приложения и т д), 
в которые вносятся определённые действия пользователя или программы.

Логи полезны для отладки различных частей программы, 
а также для сбора и анализа информации о работе системы с целью выявления ошибок. 
Всё это необходимо для контроля работы приложения, так как даже после релиза могут встретиться ошибки, 
а пользователи не всегда сообщают о багах в техподдержку. 

Чем больше процессов автоматизировано, тем быстрее будет идти разработка.
Хорошее логирование может сделать дебаггинг намного проще.

Логи состоят из записей, каждая из которых содержит 

время (timestamp), 
уровень (log level)
сообщение

*Предназначение уровней логгирования* - это предоставить пользователю способ фильтрации сообщений лога в зависимости от уровня интереса пользователя.
Например, если цель логгирования - дебаггинг, то практически все сообщения будут нужны, в то время как при общем мониторинге понадобится меньше информации.

## 2.1. Интерфейс WebDriver.Options

Методы интерфейса **WebDriver.Options**:

| Тип  | Метод  | Описание        | 
|------|--------|-----------------|
| Logs | logs() | Получение логов |

[selenium/docs/api : WebDriver.Options](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/WebDriver.Options.html)

## 2.2. Интерфейс Logs

**Logs** - интерфейс предоставляющий методы работы с логами.

Методы интерфейса **Logs**:

| Тип         | Метод                  | Описание                        | 
|-------------|------------------------|---------------------------------|
| LogEntries  | get(String logType)    | Получение логов заданного типа  |
| Set<String> | getAvailableLogTypes() | Получение доступных типов логов |

[selenium/docs/api : Logs](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/logging/Logs.html)

### 2.2.1. Получение логов

*Пример*

```java
Logs logs = driver.manage().logs();
LogEntries logEntries = logs.get(LogType.DRIVER);
for (LogEntry logEntry : logEntries) {
    System.out.println(logEntry.getMessage());
}
```

### 2.2.2. Получение типов логов

Webdriver может быть использован в различных конфигурациях. 
К примеру, клиент, запускающий тест (Java), может напрямую взаимодействовать с драйвером (локальный запуск), 
который контролирует браузер, или опосредованно через сервер (удаленный запуск). 
В зависимости от конфигурации могут быть доступны различные типы логов. 
Поэтому webdriver предоставляет возможность узнать типы поддерживаемых логов.

*Пример*

```java
Set<String> availableLogTypes = driver().manage().logs().getAvailableLogTypes();

```

## 2.3. Класс LogType

***LogType*** - класс представляющий уровни логирования

Константы класса **LogType**:

| Тип           | Константа   | Описание                                                       | 
|---------------|-------------|----------------------------------------------------------------|
| static String	| BROWSER     | Логи от javascript консоли браузера                |
| static String	| CLIENT      | Логи от клиентской части протокола Webdriver (например, Java bindings)                 |
| static String	| DRIVER      | Внутренние логи драйвера (например, логи FirefoxDriver)    |
| static String	| PERFORMANCE | Логи относящиеся к производительности на странице (тайминги загрузки ресурсов) |
| static String	| PROFILER    | This log type pertains to logs relating to performance timings |
| static String	| SERVER      | Логи от Selenium сервера          |

[selenium/docs/api : LogType](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/logging/LogType.html)

В целом, при дебагинге определенной конфигурации было бы полезно получить доступ к логам каждого отдельного компонента конфигурации. 
А это: клиент (Java bindings), сервер (если Grid), драйвер и браузер. Все же логи всех компонентов не могут быть доступны во всех конфигурациях. 
Пример с использованием сервера (или не использованием) - самый простой, но логи также могут не поддерживаться или их невозможно будет получить из-за браузера. 
В придачу к этому, иногда могут быть доступны и некоторые другие типы логов. 
Например, могут быть доступны логи, предназначенные для сбора данных о производительности на стороне клиента.

Webdriver может быть использован в различных конфигурациях.
К примеру, клиент запускающий тест (Java) может напрямую взаимодействовать с драйвером (локальный запуск),
который контролирует браузер, или опосредованно через сервер (удаленный запуск).
В зависимости от конфигурации могут быть доступны различные типы логов.
Поэтому Webdriver предоставляет возможность узнать типы поддерживаемых логов.

| Типы        | Описание                                                                        | 
|-------------|---------------------------------------------------------------------------------|
| browser     | логи от javascript консоли браузера                                             |
| client      | логи от клиентской части протокола Webdriver (например, Java bindings)          |
| driver      | логи драйвера (например, логи FirefoxDriver)                                    |
| performance | логи относящиеся к производительности на странице (тайминги загрузки ресурсов)  |
| server      | логи от Selenium сервера                                                        |

Для Webdriver были разработаны следующие уровни логгирования (в порядке возрастания детализированности):

| Уровень | Описание                                                 | Пример                                   |
|---------|----------------------------------------------------------|------------------------------------------|
| OFF     | Логгирование отключено                                   |                                          |
| SEVERE  | Сообщения об ошибках                                     | при неизвестной команде                  |
| WARNING | Предупреждения о том, что могло быть неверным            | перехваченное исключение                 |
| INFO    | Сообщения информативного характера о полученных командах |  о полученных командах                   |
| DEBUG   | Сообщения для дебаггинга                                 | информация о состоянии драйвера          |
| ALL     | Все сообщения                                            | все сообщения независимо от его уровня   |

Языки программирования вроде Java или Python предоставляют свои API логгирования со своими уровнями.
Интерфейс вебдрайвера Log может работать с Java LogType.
Однако следует иметь в виду, что внутри webdriver API уровень логгирования языка программирования должен быть преобразован
в уровень логгирования Webdriver, прежде чем отправится запрос.

## 2.4. Класс LogEntries

***LogEntries*** - класс представляющий пул логов.

Методы класса **LogEntries**:

| Тип                 | Метод      | Описание                        | 
|---------------------|------------|---------------------------------|
| List<LogEntry>      | getAll()   | Получение логов заданного типа  |
| Iterator<LogEntry>  | iterator() | Получение доступных типов логов |
| Map<String, Object> | toJson()   | Преобразование в JSON объект    |

[selenium/docs/api : LogEntries](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/logging/LogEntries.html)

## 2.5. Класс LogEntry

***LogEntry*** - класс представляющий запись лога.

Методы класса **LogEntry**:

| Тип                 | Метод          | Описание                                      | 
|---------------------|----------------|-----------------------------------------------|
| Level               | getLevel()     | Получение уровня логгирования                 |
| String              | getMessage()   | Получение сообщения в логе                    |
| long                | getTimestamp() | Получение таймштампа (количество миллисекунд) |
| Map<String, Object> | toJson()       | Преобразование в JSON объект                  |

[selenium/docs/api : LogEntry](https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/logging/LogEntry.html)

*Пример*

```java
Logs logs = driver.manage().logs();
LogEntries logEntries = logs.get(LogType.DRIVER);
for (LogEntry logEntry : logEntries) {
    System.out.println(logEntry.getMessage());
}
```

## 2.6. Класс LoggingPreferences

***LoggingPreferences*** - класс представляющий настройки логов.

Методы класса **LoggingPreferences**:

| Тип                 | Метод                                    | Описание                                      | 
|---------------------|------------------------------------------|-----------------------------------------------|
| Level               | getLevel()                               | получение уровня логгирования                 |
| LoggingPreferences  | addPreferences(LoggingPreferences prefs) | Adds the given logging preferences giving them precedence over existing preferences. |
| void                | enable(String logType, Level level)      | Enables logging for the given log type at the specified level and above. |
| Set<String>         | getEnabledLogTypes()                     | 	                                                |

### 2.6.1. Конфигурация логгирования

Бывают ситуации, когда логгирование необходимо полностью отключить, или сделать минимальным количество сообщений. 
Например, в случае, когда драйвер работает на устройстве с ограниченными ресурсами. 
Для поддержки таких ситуаций должна быть возможность конфигурировать логгирование как отдельная настройка в вебдрайвере. 
Реализовано это путем передачи драйверу списка пар тип лога - уровень логгирования. 
В большинстве реализаций клиентской части это сделано через DesiredCapabilities класс.

*Пример*

```java
DesiredCapabilities caps = DesiredCapabilities.firefox();
LoggingPreferences logs = new LoggingPreferences();
logs.enable(LogType.BROWSER, Level.OFF);
logs.enable(LogType.CLIENT, Level.SEVERE);
logs.enable(LogType.DRIVER, Level.WARNING);
logs.enable(LogType.PERFORMANCE, Level.INFO);
logs.enable(LogType.SERVER, Level.ALL);
WebDriver driver = new FirefoxDriver(caps);
```

***

# 2. Скриншоты

***Скриншот*** - изображение, полученное устройством и показывающее в точности то, 
что видит пользователь на экране монитора или другого визуального устройства вывода.

Одна из основных целей автоматизированного тестирования — сокращение ручного труда.
При работе с автоматизированными тестами в **Selenium** часто приходится делать скриншот веб-страницы или ее части. 
Это полезно, особенно при отладке ошибок или проверке согласованности поведения приложения в разных браузерах.
Не хотелось бы сидеть и следить за приложением каждый раз, когда выполняются тесты.
Поэтому снятие скриншотов приносит много пользы.

Скриншоты снимаются во время выполнения теста с помощью скрипта, который помогает

* проверить функциональность или состояние приложения после выполнения теста
* анализировать ошибки, просматривая состояние приложения, когда тест-кейс оканчивается неудачей

Скриншоты особенно полезны при выполнении headless-тестов, где не виден графический интерфейс приложения. 
Тем не менее Selenium захватит и сохранит скриншот, чтобы вы могли проверить его позже.
 
## 2.1. Интерфейс TakeScreenshot

***TakeScreenshot*** - интерфейс предоставляющий методы для снятия скриншотов страницы.
                     
Методы интерфейса:

| Тип                 | Метод                                    | Описание                                      |        
|---------------------|------------------------------------------|-----------------------------------------------|        
| Level               | getScreenshotAs(OutputType<X> target)                     | 	                                                |     

*Пример*

```java
TakesScreenshot screenShot =(TakesScreenshot)driver;
FileHandler.copy(screenShot.getScreenshotAs(OutputType.FILE), new File("path/to/destination/folder/screenshot.png"));

File scrFile = ((TakesScreenshot)driver).getScreenshotAs(OutputType.FILE);
FileUtils.copyFile(scrFile, new File("c:\\tmp\\screenshot.png"));
```

For a W3C-conformant WebDriver or WebElement, this behaves as stated in W3C WebDriver specification.

For a non-W3C-conformant WebDriver, this makes a best effort depending on the browser to return the following in order of preference:

Entire page
Current window
Visible portion of the current frame
The screenshot of the entire display containing the browser
For a non-W3C-conformant WebElement extending TakesScreenshot, this makes a best effort depending on the browser to return the following in order of preference:
The entire content of the HTML element
The visible portion of the HTML element

WebDriverException - on failure.
java.lang.UnsupportedOperationException - if the underlying implementation does not support screenshot capturing.

### 2.1.1. Скриншот всей страницы

### 2.1.2. Скриншот просматриваемой области

### 2.1.3. Скриншот веб элемента 

## 2.2. Интерфейс OutputType<T>

***OutputType<T>***

static OutputType<java.lang.String>	BASE64
Obtain the screenshot as base64 data.
static OutputType<byte[]>	BYTES
Obtain the screenshot as raw bytes.
static OutputType<java.io.File>	FILE
Obtain the screenshot into a temporary file that will be deleted once the JVM exits.

T	convertFromBase64Png​(java.lang.String base64Png)
Convert the given base64 png to a requested format.
T	convertFromPngBytes​(byte[] png)
Convert the given png to a requested format.

В качестве параметра он принимает значение, которое влияет на тип возвращаемого методом результата:

BASE64 — получить скриншот в формате данных base64;
BYTES — получить скриншот как набор байт;
FILE — получить скриншот, сохраненный во временный файл, который будет удален после завершения работы JVM. Разработчик должен самостоятельно сделать копию этого файла.

***

## 2.2. Ashot

Интерфейс TakesScreenshot позволяет делать скриншоты целой страницы, текущего окна, видимой части страницы или всего дисплея, если это поддерживается браузером. Однако он не позволяет делать скриншоты отдельных элементов.

Ashot — сторонняя утилита Яндекса, поддерживаемая Selenium WebDriver для захвата скриншотов. Он делает снимок экрана отдельного WebElement, а также снимок экрана полной страницы, который важнее размера экрана.

Как скачать и настроить Ashot API?
Есть два способа настроить Ashot API

1. Использование Maven
2. вручную без использования какого-либо инструмента
   Чтобы настроить через Maven:
   Перейдите на https://mvnrepository.com/artifact/ru.yandex.qatools.ashot/ashot
   Нажмите на последнюю версию, пока. Это 1.5.4
   Скопируйте код зависимости и добавьте в ваш файл pom.xml


Сохраните файл, и Maven добавит jar к вашему пути сборки
И теперь вы готовы!

*Пример*

```java
Screenshot screenshot = new Ashot().takeScreenshot(driver);
Screenshot screenshot = new AShot().shootingStrategy(ShootingStrategies.viewportPasting(1000)).takeScreenshot(driver);
        ImageIO.write(screenshot.getImage(), "jpg", new File(".\\screenshot\\fullimage.jpg"));        
```

***

# 3. Запись видео


# 4. Запись трафика



# 5. Слушатель

EventFiringWebDriver

WebDriverEventListner

https://automation-remarks.com/selenium-logs/

Заметка о том, как залогировать действия Selenium Webdriver.
Вероятнее всего, вы всегда хотели получать больше информации от WebDriver так,
чтобы было легко дебажить скрипты или просто получать больше информации о тестах.
Теперь это стало возможным благодаря EventFiringWebDriver и WebDriverEventListner.
EventFiringWebDriver это класс, который используется как обертка над webDriver.
WebDriverEventListner - интерфейс, который нужно реализовать, чтобы получить доступ к действиям webdriver.

Поговорим чуть больше o классе EventFiringWebDriver. Этот класс реализует интерфейс WebDriver. Это означает, что в дополнение ко всем стандартным методам, появляется еще два метода:

register(WebDriverEventListener eventListener)

unregister(WebDriverEventListener eventListener)

Метод register позволяет зарегистрировать вашу реализацию WebDriverEventListner для того, чтобы слушать все действия webdriver и метод unregister позволяет прервать работу метода register.

Шаг 1: Реализуем интерфейс WebDriverEventListener

Создаем класс EventHandler и реализуем WebDriverEventListener:

package com.custom.listeners;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.events.WebDriverEventListener;

public class EventHandler implements WebDriverEventListener {

    private static final Logger LOG = LogManager.getLogger(EventHandler.class);

    @Override
    public void beforeNavigateTo(String url, WebDriver driver) {

    }

    @Override
    public void afterNavigateTo(String url, WebDriver driver) {

    }

    @Override
    public void beforeNavigateBack(WebDriver driver) {

    }

    @Override
    public void afterNavigateBack(WebDriver driver) {

    }

    @Override
    public void beforeNavigateForward(WebDriver driver) {

    }

    @Override
    public void afterNavigateForward(WebDriver driver) {

    }

    @Override
    public void beforeFindBy(By by, WebElement element, WebDriver driver) {
        LOG.debug("Should be " + by);
    }

    @Override
    public void afterFindBy(By by, WebElement element, WebDriver driver) {
        LOG.debug("Element found");
    }

    @Override
    public void beforeClickOn(WebElement element, WebDriver driver) {
        LOG.debug("Should click " + element.getTagName());
    }

    @Override
    public void afterClickOn(WebElement element, WebDriver driver) {
        LOG.debug("Clicked successfull");
    }

    @Override
    public void beforeChangeValueOf(WebElement element, WebDriver driver) {

    }

    @Override
    public void afterChangeValueOf(WebElement element, WebDriver driver) {

    }

    @Override
    public void beforeScript(String script, WebDriver driver) {

    }

    @Override
    public void afterScript(String script, WebDriver driver) {

    }

    @Override
    public void onException(Throwable throwable, WebDriver driver) {

    }
}
Шаг 2: Регистрируем слушателя

Создаем простой объект webdriver:

WebDriver driver = new FirefoxDriver();
Создаем объект EventFiringWebDriver и передаем ему созданный объект driver:

EventFiringWebDriver eventDriver = new EventFiringWebDriver(driver);
Регистрируем EventHandler:

eventDriver.register(new EventHandler());
Все, теперь мы можем спокойно писать тесты, как мы это делали раньше и при этом логировать действия драйвера.

import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.firefox.FirefoxDriver;
import org.openqa.selenium.support.events.EventFiringWebDriver;

public class Demo {
public static void main(String[] args) {
EventFiringWebDriver eventDriver = new EventFiringWebDriver(new FirefoxDriver());
EventHandler handler = new EventHandler();
eventDriver.register(handler);
eventDriver.get("http://automation-remarks.com");
WebElement element = eventDriver.findElement(By.id("target"));
element.click();
}
}
В результате запуска у нас получится такой вот лог:

DEBUG com.home.custom.listeners.WDriverEventListener beforeFindBy - Should be By.name: banner
DEBUG com.home.custom.listeners.WDriverEventListener beforeFindBy - Should be By.name: banner
DEBUG com.home.custom.listeners.WDriverEventListener afterFindBy - Element found
DEBUG com.home.custom.listeners.WDriverEventListener beforeFindBy - Should be By.id: ibm-banner-welcome
DEBUG com.home.custom.listeners.WDriverEventListener beforeFindBy - Should be By.id: ibm-banner-welcome
DEBUG com.home.custom.listeners.WDriverEventListener afterFindBy - Element found
Вот так просто можно улучшить логирование в вашем тестовом фреймворке. Читабельных вам логов и удачи. Подписывайтесь на нашу рассылку;)


***

Практика [![Перейти](https://img.shields.io/badge/-%D0%9F%D0%B5%D1%80%D0%B5%D0%B9%D1%82%D0%B8-blue)](2.%20Практика.md)



